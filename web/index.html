<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>TFS Daily Updates — v.1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-weak: #e0e7ff;
      --success: #0a7a0a;
      --danger: #b00020;
      --table-head: #f6f6f6;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f17;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #111827;
        --border: #2d3648;
        --accent: #60a5fa;
        --accent-weak: #1f2937;
        --success: #22c55e;
        --danger: #ef4444;
        --table-head: #0f172a;
      }
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: min(1400px, 96vw);
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      margin: 8px 0 4px;
      font-size: 24px;
    }

    h3 {
      margin: 0 0 10px;
    }

    p {
      margin: 0 0 8px;
    }

    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      margin: 8px 0;
      align-items: center;
    }

    input,
    select,
    textarea {
      padding: 8px 10px;
      font-size: 14px;
      display: block;
      background: var(--card);
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    select {
      width: 100%;
    }

    label {
      color: var(--muted);
    }

    button {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: white;
    }

    button.secondary {
      background: transparent;
      color: var(--fg);
    }

    button[disabled],
    a[disabled] {
      opacity: .6;
      pointer-events: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
      vertical-align: top;
    }

    th {
      background: var(--table-head);
      text-align: left;
    }

    tbody tr:hover {
      background: var(--accent-weak);
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-weak);
      color: var(--fg);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .card {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      margin: 14px 0;
      box-shadow: 0 1px 0 rgba(0, 0, 0, .04);
    }

    .hidden {
      display: none !important;
    }

    /* sticky footer action for Submit Progress */
    .sticky-actions {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status {
      margin-left: 8px;
      font-size: 13px;
    }

    .status.ok {
      color: var(--success);
    }

    .status.err {
      color: var(--danger);
    }

    .help {
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* simple skeleton row */
    .skeleton td {
      position: relative;
    }

    .skeleton td::after {
      content: "";
      display: block;
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, rgba(0, 0, 0, .06), rgba(0, 0, 0, .12), rgba(0, 0, 0, .06));
      animation: shimmer 1.2s infinite;
      margin: 8px 0;
    }

    @media (prefers-color-scheme: dark) {
      .skeleton td::after {
        background: linear-gradient(90deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .12), rgba(255, 255, 255, .05));
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200px 0
      }

      100% {
        background-position: 200px 0
      }
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* PM sections grid */
    .section-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }


    .card.thin {
      margin: 0;
      padding: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      z-index: 999;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open,
    .modal-backdrop.open {
      display: flex;
    }

    .modal-card {
      /* width: min(720px, 96vw); */
      width: min(50vw, 96vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .modal-body {
      padding: 14px;
      max-height: 70vh;
      overflow: auto;
    }

    .modal-foot {
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-close {
      background: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 18px;
      font-weight: 600;
      background: #e5e7eb;
      color: #111827;
      /* neutral gray */
      vertical-align: baseline;
    }

    .badge.ok {
      background: #22c55e;
      color: #ffffff;
    }

    /* green */
    .badge.muted {
      background: #9ca3af;
      color: #111827;
    }

    /* gray */
    .badge.off {
      background: #ef4444;
      color: #ffffff;
    }

    /* red (DB offline) */

    /* Code family badges */
    .badge.code-100,
    .badge.code-200,
    .badge.code-300,
    .badge.code-400 {
      background: var(--accent-weak);
      color: var(--fg);
    }

    .badge.code-500 {
      background: #16a34a;
      color: #ffffff;
    }

    /* done */
    .badge.code-600 {
      background: #f59e0b;
      color: #111827;
    }

    /* challenge */
    .badge.code-700 {
      background: #eab308;
      color: #111827;
    }

    /* investigation */
    .badge.code-800 {
      background: #ef4444;
      color: #ffffff;
    }

    /* delay */

    /* Desktop: PM grid in 2 columns */
    @media (min-width: 1024px) {
      .section-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Sticky header for My Tickets */
    #ticketsTbl thead th {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* PM: two-column split inside a card */
    /* PM: two equal-width columns */
    .pm-2col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      /* equal widths */
      gap: 16px;
      align-items: start;
    }

    .pm-2col>div {
      min-width: 0;
    }

    /* prevent overflow/scrolling */

    @media (max-width: 900px) {
      .pm-2col {
        grid-template-columns: 1fr;
      }

      /* stack on small screens */
    }

    /* align toolbar content to the right inside its grid cell */
    .toolbar.right {
      justify-content: flex-end;
    }

    /* Two equal-width fields inside the right cell */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      align-items: center;
    }

    /* .field label {
      display: block;
      margin-bottom: 4px;
    } */
    .field {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .field input {
      width: 100%;
    }

    @media (max-width: 800px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Pre-Meeting Updates: compact cards per user, 2-up on wide screens */
    .pre-list {
      display: grid;
      gap: 14px;
    }

    @media (min-width: 1100px) {
      .pre-list {
        grid-template-columns: 1fr;
      }
    }

    .pre-user {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--card);
    }

    .pre-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      background: var(--table-head);
      border-bottom: 1px solid var(--border);
    }

    .pre-ident {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .pre-title {
      font-weight: 600;
    }

    .pre-meta {
      color: var(--muted);
      font-size: 12px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      font-weight: 700;
      background: var(--accent-weak);
      color: var(--fg);
    }

    .subgroup {
      padding: 8px 12px;
      border-top: 1px dashed var(--border);
      color: var(--muted);
      font-weight: 600;
    }

    .today-grid {
      margin: 0;
      border-top: 0;
    }

    .today-grid th,
    .today-grid td {
      font-size: 12.5px;
    }

    .state-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="card">
      <div class="toolbar" style="justify-content: space-between;">
        <div>
          <h1>TFS Daily Updates — v.1</h1>

          <p><span class="badge">POC</span> A lightweight ledger of daily ticket progress to spot blockers and track
            momentum.</p>
        </div>
        <div class="pill">
          <span id="me"></span>
          <button id="logoutBtn" class="hidden secondary" title="Sign out" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <section class="card" id="loginCard">
      <h3>Login</h3>
      <div class="row"><label for="loginEmail">Email</label><input id="loginEmail" placeholder="dev@company.com"
          autocomplete="username" /></div>
      <div class="row"><label for="loginPw">Password</label><input id="loginPw" type="password" placeholder="••••••"
          autocomplete="current-password" /></div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button onclick="signup()">Sign Up</button>
          <button onclick="login()">Log In</button>
          <span id="loginStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </section>

    <section class="card hidden" id="ticketsCard">
      <h3>My Tickets <small id="iterLabel" class="badge muted" title="Active iteration">—</small></h3>
      <div id="findFilters">
        <div class="row"><label for="assigned">Assigned to</label><input id="assigned"
            placeholder="email or domain\alias" /></div>
        <div class="row"><label for="q">Contains</label><input id="q" placeholder="search title/id (optional)" /></div>
      </div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button id="loadBtn" onclick="loadTickets()">Load</button>
          <span id="loadStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
      <table id="ticketsTbl" aria-live="polite">
        <thead>
          <tr>
            <th style="width:100px">ID</th>
            <th style="width:110px">Type</th>
            <th style="width:350px">Title</th>
            <th style="width:120px">State</th>
            <th style="width:75px">Code</th>
            <th>Note</th>
            <th style="width:75px">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <section id="submitCard" aria-labelledby="spHeader">
        <h3 style="margin-top: 1.33rem;">Submit Progress</h3>

        <div class="sticky-actions">
          <div class="row">
            <label>
              <button class="secondary" onclick="lockDay()">Update Complete</button>
              <span id="lockStatus" class="status" role="status" aria-live="polite"
                style="display: inline-block;"></span>
            </label>
            <p>This locks in your updates for today so PMs can
              finalize the report. After locking, only a PM can
              unlock
              you.</p>
          </div>

        </div>
      </section>



    </section>



    <section id="pm" class="card hidden" data-role="pm-only" aria-labelledby="pmHeader">
      <div class="section-grid">
        <!-- (1) Pre-Meeting Updates -->
        <section class="card thin" aria-labelledby="preHeader">
          <h3 id="preHeader">Pre-Meeting Updates</h3>
          <div id="today"></div>
        </section>

        <!-- (2) Who hasn't updated yet -->
        <section class="card thin" aria-labelledby="missingHeader">
          <div class="pm-2col">
            <!-- LEFT: Who hasn't updated -->
            <div>

              <h3 id="missingHeader">Who hasn't updated yet</h3>



              <div id="missing"></div>
              <div class="toolbar">
                <button onclick="loadMissing()">Refresh</button>
              </div>
            </div>

            <!-- RIGHT: Unlock a user -->
            <div>
              <h3 id="unlockHeader">Unlock a user</h3>
              <div class="row">
                <label for="unlockEmail">User email</label>
                <input id="unlockEmail" placeholder="dev@company.com" />
              </div>
              <div class="row">
                <div></div>
                <div class="toolbar">
                  <button onclick="pmUnlock()">Unlock</button>
                  <span id="unlockStatus" class="status" role="status" aria-live="polite"></span>
                </div>
              </div>
            </div>
          </div>
        </section>




        <!-- Report -->
        <section class="card thin" aria-labelledby="reportsHeader">
          <div class="row">
            <h3 id="reportsHeader" style="margin:0; max-width: fit-content;">Reports</h3>
            <div class="toolbar right">
              <button onclick="presetReportThisWeek(true)">This week</button>
              <button onclick="presetReportThisMonth(true)">This month</button>
              <button onclick="loadReportRange()">Load</button>
              <a id="dlRange" class="secondary" target="_blank" href="/api/updates/range.tsv">Download TSV</a>
            </div>
          </div>

          <!-- From/To side-by-side -->


          <div class="grid-2">
            <div class="field">
              <label for="repFrom">From</label>
              <input id="repFrom" type="date" />
            </div>
            <div class="field">
              <label for="repTo">To</label>
              <input id="repTo" type="date" />
            </div>
          </div>


          <div class="table-wrap">
            <table id="reportTbl">
              <thead>
                <tr>
                  <th style="width:110px">Date</th>
                  <th style="width:140px">Assigned to</th>
                  <th style="width:100px">Ticket</th>
                  <th style="width:110px">Type</th>
                  <th>Title</th>
                  <th style="width:120px">State</th>
                  <th style="width:120px">Code</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <h4 id="downloadHeader">Pre-Meeting Downloads</h4>
          <div class="row">
            <div></div>
            <div class="toolbar">
              <a id="tsvLive" href="/api/updates/today.tsv" target="_blank">Download Live TSV</a>
              <span>·</span>
              <a id="tsvFinal" href="/api/exports/today" target="_blank">Download Final TSV</a>
              <span id="exportStatus" class="status" role="status" aria-live="polite"></span>
            </div>
          </div>
        </section>




        <!-- (5) Blockers radar -->
        <section class="card thin" aria-labelledby="blockersHeader">
          <div class="row">
            <h3 id="blockersHeader" style="margin:0">Blockers Radar</h3>
            <div class="toolbar right">
              <button onclick="loadBlockers()">Refresh</button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="blockersTbl" aria-live="polite">
              <thead>
                <tr>
                  <th style="width:100px">ID</th>
                  <th style="width:110px">Type</th>
                  <th style="width:350px">Title</th>
                  <th style="width:120px">State</th>
                  <th style="width:100px">Code</th>
                  <th>Note</th>
                  <th style="width:180px">Iteration</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

      </div>

    </section>

    <!-- Submit Progress Modal -->
    <div id="spBackdrop" class="modal-backdrop" onclick="closeSPModal()"></div>
    <div id="spModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="spTitle">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-head">
          <h3 id="spTitle">Submit Progress</h3>
          <button class="modal-close" onclick="closeSPModal()" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="row"><label for="tId">Ticket ID</label><input id="tId" inputmode="numeric" /></div>
          <div class="row">
            <label for="code">Progress Code</label>
            <select id="code" hx-get="/api/ui/progress-codes/options" hx-trigger="load" hx-swap="innerHTML"></select>
          </div>
          <div class="row"><label for="note">Note</label><textarea id="note" rows="4"
              placeholder="short, concrete update"></textarea></div>
          <div class="row"><label>&nbsp;</label><small id="noteHint" class="help">A note may be required for some
              codes.</small></div>
        </div>
        <div class="modal-foot">
          <button class="secondary" onclick="closeSPModal()">Cancel</button>
          <button id="submitBtn" onclick="submitProgress()">Submit</button>
          <span id="submitStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>


  </div>

  <script>
    (function () {
      // ES5-compatible script (no arrow fns, no optional chaining, no template strings)
      var API = "";
      var tokenKey = "pocToken";

      function byId(id) { return document.getElementById(id); }

      function setStatus(id, msg, ok) {
        if (ok === void 0) ok = true;
        var el = byId(id);
        if (!el) return;
        el.classList.remove('ok');   // remove old state
        el.classList.remove('err');
        el.classList.add('status');
        el.classList.add(ok ? 'ok' : 'err');
        el.textContent = msg || '';
      }


      function token() { return localStorage.getItem(tokenKey) || ""; }

      function esc(s) {
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        s = (s == null) ? "" : String(s);
        return s.replace(/[&<>"']/g, function (c) { return map[c]; });
      }

      function requiresNote(code) {
        var sel = document.getElementById('code');
        if (!sel) return false;
        var opt = sel.querySelector('option[value="' + code + '"]');
        return !!(opt && opt.getAttribute('data-requirenote') === 'true');
      }


      function clearForNewSession() {
        var ids = ['loginStatus', 'loadStatus', 'submitStatus', 'lockStatus', 'exportStatus', 'unlockStatus'];
        for (var i = 0; i < ids.length; i++) { var el = byId(ids[i]); if (el) el.textContent = ''; }
        var le = byId('loginEmail'); if (le) le.value = '';
        var lp = byId('loginPw'); if (lp) lp.value = '';
        var tId = byId('tId'); if (tId) tId.value = '';
        var codeSel = byId('code'); if (codeSel) codeSel.selectedIndex = 0;
        var note = byId('note'); if (note) note.value = '';
        var assigned = byId('assigned'); if (assigned) assigned.value = '';
        var q = byId('q'); if (q) q.value = '';
        var filters = byId('findFilters'); if (filters) filters.style.display = '';
        var tbody = document.querySelector('#ticketsTbl tbody'); if (tbody) tbody.innerHTML = '';
        var sec = ['today', 'blockers', 'missing'];
        for (var j = 0; j < sec.length; j++) { var el2 = byId(sec[j]); if (el2) el2.innerHTML = ''; }
        setSelectButtonsDisabled(false);
      }

      function setSelectButtonsDisabled(on) {
        var btns = document.querySelectorAll('#ticketsTbl tbody button');
        for (var i = 0; i < btns.length; i++) btns[i].disabled = !!on;
      }


      function setMe(email, name) {
        var assigned = byId("assigned");
        if (assigned && !assigned.value && email) {
          assigned.value = String(email).split("@")[0];
        }
        var me = byId("me");
        me.textContent = email ? (name || email) : "";
        var btn = byId("logoutBtn");
        if (btn) btn.classList.toggle("hidden", !email);

        if (!email) {
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        }
      }

      function setRoleUI(role) {
        var isPM = (role === 'pm');
        window.__role = role;
        var loginCard = byId('loginCard');
        var ticketsCard = byId('ticketsCard');
        var submitCard = byId('submitCard');
        var pmBox = byId('pm');

        if (loginCard) loginCard.classList.add('hidden');
        if (ticketsCard) ticketsCard.classList.remove('hidden');
        // if (submitCard) submitCard.classList.remove('hidden');
        if (submitCard) submitCard.classList.toggle('hidden', isPM); // hide for PMs
        if (pmBox) pmBox.classList.toggle('hidden', !isPM);

        if (pmBox) {
          var controls = pmBox.querySelectorAll('button, a');
          for (var i = 0; i < controls.length; i++) {
            if (!isPM) controls[i].setAttribute('disabled', 'disabled');
            else controls[i].removeAttribute('disabled');
          }
        }

        var me = byId("me");
        if (me) {
          var txt = me.textContent;
          me.innerHTML = esc(txt);
          var badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = isPM ? 'PM' : 'DEV';
          me.appendChild(document.createTextNode(' '));
          me.appendChild(badge);
        }

        var filters = byId('findFilters');
        if (isPM) {
          ensureAssignedDropdownForPM();
          if (filters) filters.style.display = '';
          loadToday(); loadBlockers(); loadMissing(); loadExportStatus();

          presetReportThisWeek(false);
          if (!window.__exportTimer) {
            window.__exportTimer = setInterval(function () {
              var pmEl = byId('pm');
              if (pmEl && !pmEl.classList.contains('hidden')) { loadExportStatus(); }
            }, 60000);
          }
        } else {
          if (filters) filters.style.display = 'none';
          loadTickets();
        }
      }

      function syncNoteRequirement() {
        var code = byId('code').value;
        var note = byId('note');
        var hint = byId('noteHint');
        var need = requiresNote(code);
        note.required = !!need;
        hint.style.fontWeight = need ? '600' : '400';
        hint.style.opacity = need ? '1' : '.7';
      }

      function req(method, url, body, headers) {
        var opts = { method: method, headers: headers || {} };
        if (body != null) opts.body = body;
        return fetch(url, opts).then(function (res) { return res.json(); });
      }

      function signup() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Signing up...");
        req('POST', (API || location.origin) + "/api/auth/signup", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) { if (js.error) setStatus("loginStatus", js.error, false); else setStatus("loginStatus", "Account created. Please login."); })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function login() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Logging in...");
        req('POST', (API || location.origin) + "/api/auth/login", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) {
            if (js.error) { setStatus("loginStatus", js.error, false); return; }
            clearForNewSession();
            localStorage.setItem(tokenKey, js.token);
            setMe(js.email, js.name);
            setRoleUI(js.role || 'dev');
            refreshIterationBadge();
            setStatus("loginStatus", "Logged in.");
          })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function logout(all) {
        if (all === void 0) all = false;
        var t = localStorage.getItem("pocToken");
        var done = function () {
          localStorage.removeItem("pocToken");
          clearForNewSession();
          setMe("", "");
          setStatus("loginStatus", "Logged out.");
          var lb = byId("logoutBtn"); if (lb) lb.classList.add("hidden");
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        };
        if (t) {
          req('POST', (API || location.origin) + (all ? "/api/auth/logout_all" : "/api/auth/logout"), null, { "Authorization": "Bearer " + t }).then(function () { done(); }).catch(function () { done(); });
        } else { done(); }
      }

      function ensureAssignedDropdownForPM() {
        var isPM = (window.__role === 'pm');
        if (!isPM) return;

        var original = byId('assigned');
        if (!original) return;

        // If we already replaced it, skip
        if (original.tagName && original.tagName.toLowerCase() === 'select') return;

        // Create a <select> with the same id
        var sel = document.createElement('select');
        sel.id = 'assigned';
        sel.setAttribute('aria-label', 'Assigned to');
        sel.style.minWidth = '220px';

        // Put a placeholder option
        var blank = document.createElement('option');
        blank.value = '';
        blank.textContent = '— All / Anyone —';
        sel.appendChild(blank);

        // Replace the input with the select in-place
        original.parentNode.replaceChild(sel, original);

        // Load team-members
        var tkn = localStorage.getItem('pocToken') || '';
        fetch((API || location.origin) + '/api/team-members', {
          headers: { 'Authorization': 'Bearer ' + tkn }
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (!js || js.error) return;
            var items = js.items || [];

            items.forEach(function (m) {
              var opt = document.createElement('option');
              // value = alias; label = Display Name (alias) <email>
              opt.value = (m.alias || '').trim();
              if (m.email) opt.setAttribute('data-email', String(m.email).trim().toLowerCase());
              var label = m.display_name ? m.display_name : (m.alias || '');
              var extra = [];
              if (m.alias) extra.push(m.alias);
              if (m.email) extra.push(m.email);
              opt.textContent = label + (extra.length ? (' — ' + extra.join(' · ')) : '');
              sel.appendChild(opt);
            });
          })
          .catch(function () { /* ignore network errors silently */ });

        // When changed, auto-run the ticket search (handy for PMs on My Tickets)
        sel.addEventListener('change', function () {
          var loadBtn = byId('loadBtn');
          if (loadBtn) loadBtn.click();
        });
      }


      function loadTickets() {
        var assigned = byId("assigned");
        var q = byId("q");
        var btn = byId("loadBtn");
        var status = byId("loadStatus");
        status.textContent = "Loading...";
        btn.disabled = true;

        var tbody = document.querySelector("#ticketsTbl tbody");
        tbody.innerHTML = "";
        for (var i = 0; i < 5; i++) {
          var tr = document.createElement('tr'); tr.className = 'skeleton';
          tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td>';

          tbody.appendChild(tr);
        }
        var url = new URL((API || location.origin) + "/api/tickets");
        if (assigned && assigned.value.trim()) url.searchParams.set("assignedTo", assigned.value.trim());
        if (q && q.value.trim()) url.searchParams.set("q", q.value.trim());

        // PMs: also tell the API whose updates (code/note) to surface
        if (window.__role === 'pm' && assigned && assigned.tagName &&
          assigned.tagName.toLowerCase() === 'select' && assigned.value.trim()) {
          var selOpt = assigned.options[assigned.selectedIndex];
          var email = selOpt ? (selOpt.getAttribute('data-email') || '') : '';
          if (email) url.searchParams.set('updatesBy', email);
        }

        var hdrs = {};
        var tkn = localStorage.getItem("pocToken");
        if (tkn) hdrs["Authorization"] = "Bearer " + tkn;

        fetch(url, { headers: hdrs })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            status.textContent = "Loaded " + (js.count || 0) + " ticket(s)";
            tbody.innerHTML = "";
            var items = js.items || [];
            for (var k = 0; k < items.length; k++) {
              var t = items[k];
              var tr2 = document.createElement("tr");
              tr2.setAttribute("data-id", String(t.id));
              var code = t.lastCode || t.progressCode || t.code || '';
              var note = t.lastNote || t.progressNote || t.note || '';
              var typ = t.type || t.workItemType || t.itemType || t.kind || '';
              tr2.innerHTML =
                '<td>' + esc(t.id) + '</td>' +
                '<td>' + esc(typ || '—') + '</td>' +
                '<td><i>' + esc(t.title) + '</i></td>' +
                '<td>' + esc(t.state) + '</td>' +
                '<td>' + esc(code || '—') + '</td>' +
                '<td>' + esc(note || '—') + '</td>' +
                '<td>' + (window.__role === 'pm'
                  ? ''
                  : '<button class="secondary" onclick="openSPModal(' + Number(t.id) + ')" aria-label="Select ticket ' + esc(t.id) + '">Select</button>') + '</td>';


              tbody.appendChild(tr2);
              var cells = tr2.getElementsByTagName('td');
              renderCodeBadge(cells[4], code);

            }
          })
          .catch(function () {
            status.textContent = "Failed to load";
            status.classList.add('err');
            tbody.innerHTML = '<tr><td colspan="7">Unable to load tickets. Check network or try again.</td></tr>';
          })
          .finally(function () { btn.disabled = false; });
      }

      function openSPModal(id) {
        if (window.__role === 'pm') return; // PMs don’t submit progress
        var m = byId('spModal'), b = byId('spBackdrop');
        if (id != null) byId('tId').value = String(id);
        // ensure note-required hint is correct (HTMX may have just populated options)
        if (window.syncNoteRequirement) syncNoteRequirement();
        m.classList.add('open'); b.classList.add('open');
        // focus first field
        setTimeout(function () { var t = byId('tId'); if (t) t.focus(); }, 0);
      }

      function closeSPModal() {
        var m = byId('spModal'), b = byId('spBackdrop');
        m.classList.remove('open'); b.classList.remove('open');
      }

      // ESC to close
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') { closeSPModal(); }
      });

      // after a successful submit, we already update the row inline;
      // also close the modal there:


      function prefill(id) {
        byId("tId").value = id;
        byId('submitCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function submitProgress() {
        var tkn = token();
        if (!tkn) { setStatus("submitStatus", "Please login first.", false); return; }
        var ticket = byId("tId").value.trim();
        var code = byId("code").value;
        var note = byId("note").value.trim();
        if (!ticket) { setStatus("submitStatus", "Ticket ID is required.", false); return; }
        if (requiresNote(code) && !note) { setStatus("submitStatus", "A note is required for this code.", false); return; }
        setStatus("submitStatus", "Submitting...");
        var btn = byId('submitBtn'); btn.disabled = true;
        req('POST', (API || location.origin) + "/api/progress", JSON.stringify({ ticketId: ticket, code: code, note: note }), { "Content-Type": "application/json", "Authorization": "Bearer " + tkn })
          .then(function (js) {
            if (js && js.error) setStatus("submitStatus", js.error, false); else {
              setStatus("submitStatus", "Saved!");
              byId("note").value = "";
              closeSPModal();
              // Optimistically update the row in My Tickets
              var row = document.querySelector('#ticketsTbl tbody tr[data-id="' + ticket + '"]');
              if (row) {
                var cells = row.getElementsByTagName('td');
                // columns: [0]=ID, [1]=Title, [2]=State, [3]=Code, [4]=Note, [5]=Action
                if (cells[4]) renderCodeBadge(cells[4], code || '');
                if (cells[5]) cells[5].textContent = note || '—';
              } else {
                // if the table isn't loaded yet or row not found, just refresh
                if (typeof loadTickets === 'function') { loadTickets(); }
              }

            }
          })
          .catch(function () { setStatus("submitStatus", "Network error", false); })
          .finally(function () { btn.disabled = false; });
      }

      function lockDay() {
        var tkn = token();
        if (!tkn) { setStatus("lockStatus", "Please login first.", false); return; }
        setStatus("lockStatus", "Submitting day...");
        req('POST', (API || location.origin) + "/api/updates/lock", null, { "Authorization": "Bearer " + tkn })
          .then(function (js) {
            if (js.error) setStatus("lockStatus", js.error, false);
            else setStatus("lockStatus", js.locked ? "Update submitted (locked)" : "Not locked", !!js.locked);
            if (js.locked) { setSelectButtonsDisabled(true); var badgeEl = byId("me").querySelector('.badge'); var txt = badgeEl ? badgeEl.textContent : ''; if (txt === 'PM') { loadToday(); loadBlockers(); loadMissing(); } }
          })
          .catch(function () { setStatus("lockStatus", "Network error", false); });
      }


      function initials(s) {
        s = String(s || '').trim();
        if (!s) return "?";
        var parts = s.split(/\s+/);
        var a = (parts[0] || '')[0] || '';
        var b = (parts.length > 1 ? (parts[parts.length - 1] || '')[0] : '') || '';
        return (a + b).toUpperCase();
      }
      function loadToday() {
        var box = document.getElementById("today");
        fetch((window.API || location.origin) + "/api/updates/today")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var out = [];
            out.push('<div class="pre-list">'); // grid of user cards

            var users = js.users || [];
            for (var u = 0; u < users.length; u++) {
              var user = users[u];
              var display = user.name ? user.name : user.email;
              var meta = user.name ? user.email : '';
              var tickets = user.tickets || [];
              var total = tickets.length;

              // Card head
              out.push('<div class="pre-user">');
              out.push('<div class="pre-head">');
              out.push('<div class="pre-ident">');
              out.push('<span class="avatar">' + initials(display) + '</span>');
              out.push('<div>');
              out.push('<div class="pre-title">' + esc(display) + '</div>');
              if (meta) out.push('<div class="pre-meta">' + esc(meta) + '</div>');
              out.push('</div>');
              out.push('</div>');

              // badge + total count
              out.push('<span class="pill">');
              out.push('<span class="pre-meta">' + total + ' item(s)</span>');
              out.push('<span class="badge ' + (user.locked ? 'ok' : 'muted') + '">' + (user.locked ? 'Locked' : 'Open') + '</span>');

              out.push('</span>');

              out.push('</div>'); // /pre-head

              // group by assignedTo
              var groups = {};
              for (var t = 0; t < tickets.length; t++) {
                var it = tickets[t];
                var key = (it.assignedTo && String(it.assignedTo).trim()) ? it.assignedTo : "(unassigned)";
                if (!groups[key]) groups[key] = [];
                groups[key].push(it);
              }

              var keys = Object.keys(groups).sort(function (a, b) { return a.localeCompare(b); });
              if (keys.length === 0) {
                out.push('<div class="subgroup">No updates yet today.</div>');
              } else {
                for (var k = 0; k < keys.length; k++) {
                  var gk = keys[k];
                  var arr = groups[gk];

                  // REMOVED the subgroup line with count per your request
                  // out.push('<div class="subgroup">' + esc(gk) + ' · ' + arr.length + ' item(s)</div>');

                  out.push('<table class="today-grid"><thead><tr>');
                  out.push('<th style="width:75px">ID</th>');
                  out.push('<th style="width:110px">Type</th>');
                  out.push('<th style="width:350px">Title</th>');
                  out.push('<th style="width:120px">State</th>');
                  out.push('<th style="width:75px">Code</th>');
                  out.push('<th>Note</th>');
                  out.push('</tr></thead><tbody>');

                  for (var m = 0; m < arr.length; m++) {
                    var it2 = arr[m];
                    var typ2 = it2.type || it2.workItemType || it2.itemType || it2.kind || '';
                    var fam = (it2.code ? String(it2.code).slice(0, 3) : null);
                    var codeBadge = it2.code
                      ? '<span class="badge code-' + fam + '">' + esc(it2.code) + '</span>'
                      : '—';

                    out.push('<tr>');
                    out.push('<td>' + esc(it2.ticketId) + '</td>');
                    out.push('<td>' + esc(typ2 || '—') + '</td>');
                    out.push('<td><i>' + esc(it2.title || '') + '</i></td>');
                    out.push('<td>' + esc(it2.state || '—') + '</td>');
                    out.push('<td>' + codeBadge + '</td>');
                    out.push('<td>' + esc(it2.note || '') + '</td>');
                    out.push('</tr>');
                  }

                  out.push('</tbody></table>');
                }
              }

              out.push('</div>'); // /pre-user
            }

            out.push('</div>'); // /pre-list
            box.innerHTML = '<p><span class="badge">' + esc(js.date || "") + '</span></p>' + out.join('');
          });
      }


      function ymd(d) { return d.toISOString().slice(0, 10); }

      function loadReportRange() {
        var fromEl = document.getElementById('repFrom');
        var toEl = document.getElementById('repTo');
        var from = (fromEl && fromEl.value) ? fromEl.value : ymd(new Date());
        var to = (toEl && toEl.value) ? toEl.value : from;


        // update the TSV download link
        var dl = document.getElementById('dlRange');
        if (dl) dl.href = '/api/updates/range.tsv?from=' + encodeURIComponent(from) + '&to=' + encodeURIComponent(to);

        // auth header optional; PM view likely has a token
        var hdrs = {};
        var tkn = localStorage.getItem('pocToken');
        if (tkn) hdrs['Authorization'] = 'Bearer ' + tkn;

        fetch('/api/updates/range?from=' + encodeURIComponent(from) + '&to=' + encodeURIComponent(to), { headers: hdrs })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var tb = document.querySelector('#reportTbl tbody');
            if (!tb) return;
            var items = js.items || [];
            var html = '';
            for (var i = 0; i < items.length; i++) {
              var it = items[i];
              var d = (it.date || '').slice(0, 10); // YYYY-MM-DD
              var who = it.assignedTo || '';

              // keep name only if it looks like "Name <DOMAIN\alias>"
              var lt = who.indexOf('<');
              if (lt > -1) { who = who.slice(0, lt).trim(); }
              // otherwise, if it's a raw "DOMAIN\alias", drop the DOMAIN\
              var bs = who.indexOf('\\');
              if (bs > -1 && lt === -1) { who = who.slice(bs + 1).trim(); }
              var typ3 = it.type || it.workItemType || it.itemType || it.kind || '';
              html += '<tr>' +
                '<td>' + esc(d) + '</td>' +
                '<td>' + esc(who) + '</td>' +
                '<td>' + esc(it.ticketId) + '</td>' +
                '<td>' + esc(typ3 || '') + '</td>' +
                '<td><i>' + esc(it.title || '') + '</i></td>' +
                '<td>' + esc(it.state || '') + '</td>' +
                '<td>' + esc(it.code || '') + '</td>' +
                '<td>' + esc(it.note || '') + '</td>' +
                '</tr>';

            }
            tb.innerHTML = html || '<tr><td colspan="8"><em>No rows for the selected range.</em></td></tr>';
          })
          .catch(function () {
            var tb = document.querySelector('#reportTbl tbody');
            if (tb) tb.innerHTML = '<tr><td colspan="8">Failed to load range.</td></tr>';
          });
      }

      // optional: prefill dates to "this week" when PM page opens
      function presetReportThisWeek() {
        var now = new Date();
        var day = now.getDay();            // 0..6 (Sun..Sat)
        var diffToMon = (day + 6) % 7;         // days since Monday
        var monday = new Date(now); monday.setDate(now.getDate() - diffToMon);
        var sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        var f = document.getElementById('repFrom');
        var t = document.getElementById('repTo');
        if (f) f.value = ymd(monday);
        if (t) t.value = ymd(sunday);
      }

      function setReportRange(fromDate, toDate, autoLoad) {
        var f = document.getElementById('repFrom');
        var t = document.getElementById('repTo');
        if (f) f.value = ymd(fromDate);
        if (t) t.value = ymd(toDate);
        if (autoLoad) loadReportRange();
      }

      // Monday–Sunday of the current week
      function presetReportThisWeek(autoLoad) {
        var now = new Date();
        var day = now.getDay();                  // 0..6 (Sun..Sat)
        var diffToMon = (day + 6) % 7;           // days since Monday
        var monday = new Date(now); monday.setDate(now.getDate() - diffToMon);
        monday.setHours(0, 0, 0, 0);
        var sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23, 59, 59, 999);
        setReportRange(monday, sunday, !!autoLoad);
      }

      // First–last day of the current month
      function presetReportThisMonth(autoLoad) {
        var now = new Date();
        var first = new Date(now.getFullYear(), now.getMonth(), 1);
        var last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        setReportRange(first, last, !!autoLoad);
      }

      // Render a colored chip for a progress code (e.g., "300_01")
      function renderCodeBadge(cell, code) {
        if (!cell) return;
        if (!code) { cell.textContent = '—'; return; }
        var fam = String(code).slice(0, 3); // "100".."800"
        cell.innerHTML = '<span class="badge code-' + fam + '">' + esc(code) + '</span>';
      }

      // Keyboard shortcuts: /, L, N, Ctrl+Enter (modal submit)
      function initShortcuts() {
        document.addEventListener('keydown', function (e) {
          var tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
          if (tag === 'input' || tag === 'textarea') return;
          var k = e.key || '';
          if (k === '/') { var q = byId('q'); if (q) { e.preventDefault(); q.focus(); } }
          else if (k.toLowerCase() === 'l') { var lb = byId('loadBtn'); if (lb) { e.preventDefault(); lb.click(); } }
          else if (k.toLowerCase() === 'n') { e.preventDefault(); openSPModal(); }
          else if ((e.ctrlKey || e.metaKey) && k === 'Enter') {
            var m = byId('spModal'); if (m && m.classList.contains('open')) {
              var sb = byId('submitBtn'); if (sb) sb.click();
            }
          }
        });
      }

      // Set/clear the "current iteration" badge
      function setIterationLabel(name) {
        var el = byId('iterLabel');
        if (!el) return;
        name = (name || '').trim();
        if (name) { el.textContent = name; el.classList.remove('muted'); }
        else { el.textContent = '—'; el.classList.add('muted'); }
      }
      // Get last segment of a TFS Iteration Path (e.g., "Project\2025\Sprint 400" -> "Sprint 400")
      function lastIterSegment(path) {
        if (!path) return '';
        var p = String(path).split('\\');
        return (p[p.length - 1] || '').trim();
      }
      function refreshIterationBadge() {
        fetch((API || location.origin) + "/api/iteration/current")
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var name = (js && js.name) ? String(js.name) : '';
            // optional: shorten to last path segment (Project\2025\Sprint 400 -> Sprint 400)
            if (name.indexOf('\\') > -1) {
              var parts = name.split('\\');
              name = (parts[parts.length - 1] || '').trim();
            }
            setIterationLabel(name);
          })
          .catch(function () { /* keep badge muted on network errors */ });
      }


      function loadBlockers() {
        var tbody = document.querySelector('#blockersTbl tbody');
        if (!tbody) return;

        // skeleton rows for a quick visual while loading
        tbody.innerHTML = '';
        for (var i = 0; i < 4; i++) {
          var tr = document.createElement('tr');
          tr.className = 'skeleton';
          tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
          tbody.appendChild(tr);
        }

        fetch((API || location.origin) + "/api/updates/blockers")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var items = js.items || [];

            // sort by severity (600 > 700 > 800), then by assignedTo, then by most recent
            function sev(c) {
              if (!c) return 9;
              if (String(c).indexOf('600_') === 0) return 0; // most severe/urgent
              if (String(c).indexOf('700_') === 0) return 1;
              if (String(c).indexOf('800_') === 0) return 2;
              return 3;
            }
            items.sort(function (a, b) {
              return sev(a.code) - sev(b.code)
                || String(a.assignedTo || '').localeCompare(String(b.assignedTo || ''))
                || String(b.at || '').localeCompare(String(a.at || ''));
            });

            if (!items.length) {
              tbody.innerHTML = '<tr><td colspan="7"><em>No blockers detected today.</em></td></tr>';
              return;
            }

            var html = '';
            for (var i = 0; i < items.length; i++) {
              var h = items[i];
              // type may be absent unless added on the API (see server patch below)
              var typ = h.type || h.workItemType || h.itemType || h.kind || '';
              html += ''
                + '<tr data-id="' + esc(h.ticketId) + '">'
                + '<td>' + esc(h.ticketId) + '</td>'
                + '<td>' + esc(typ || '—') + '</td>'
                + '<td><i>' + esc(h.title || '') + '</i></td>'
                + '<td>' + esc(h.state || '') + '</td>'
                + '<td>' + esc(h.code || '—') + '</td>'
                + '<td>' + esc(h.note || '') + '</td>'
                + '<td>' + esc(h.iterationPath || '') + '</td>'
                + '</tr>';
            }
            tbody.innerHTML = html;

            // turn Code text into colored badges
            var rows = tbody.querySelectorAll('tr');
            for (var r = 0; r < rows.length; r++) {
              var cells = rows[r].getElementsByTagName('td');
              if (cells[4]) {
                var raw = cells[4].textContent;
                renderCodeBadge(cells[4], raw);
              }
            }
          })
          .catch(function () {
            tbody.innerHTML = '<tr><td colspan="7">Failed to load blockers.</td></tr>';
          });
      }



      function loadMissing() {
        var box = byId("missing");
        fetch((API || location.origin) + "/api/updates/missing", { headers: { "Authorization": "Bearer " + (localStorage.getItem("pocToken") || "") } })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            if (js.error) { box.innerHTML = '<p class="status err">' + esc(js.error) + '</p>'; return; }
            if (!js.missing || js.missing.length === 0) { box.innerHTML = '<p><span class="badge">' + esc(js.date || "") + '</span> — everyone has updated 🎉</p>'; return; }
            var html = '<p><span class="badge">' + esc(js.date || "") + '</span> — ' + js.count + ' dev(s) with no update</p><ul>';
            for (var i = 0; i < js.missing.length; i++) { var m = js.missing[i]; html += '<li>' + esc(m.label) + ' <small>(' + esc(m.email) + ')</small></li>'; }
            html += '</ul>';
            box.innerHTML = html;
          });
      }

      function pmUnlock() {
        var email = byId("unlockEmail").value.trim();
        var tkn = localStorage.getItem("pocToken") || "";
        if (!tkn) { setStatus("unlockStatus", "Please login", false); return; }
        setStatus("unlockStatus", "Unlocking...");
        req('POST', (API || location.origin) + "/api/updates/unlock", JSON.stringify({ email: email }), { "Content-Type": "application/json", "Authorization": "Bearer " + tkn })
          .then(function (js) { if (js.error) setStatus("unlockStatus", js.error, false); else setStatus("unlockStatus", 'Unlocked ' + js.target, true); })
          .catch(function () { setStatus("unlockStatus", "Network error", false); });
      }

      function loadExportStatus() {
        var tkn = localStorage.getItem("pocToken") || "";
        if (!tkn) return;

        fetch((API || location.origin) + "/api/exports/status", {
          headers: { "Authorization": "Bearer " + tkn }
        })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var box = byId("exportStatus");
            if (!box || js.error) { if (box) box.textContent = ""; return; }

            // derive state
            var dbUp = !!js.db_up;
            var has7 = js.counts && Number(js.counts.last7 || 0) > 0;
            var todayC = Number((js.counts && js.counts.today) || 0);
            var last7C = Number((js.counts && js.counts.last7) || 0);

            // badge label
            var badgeTxt = (dbUp && has7) ? 'Data ready' : (dbUp ? 'No recent data' : 'DB offline');

            // NEW: choose color class
            var badgeClass = (dbUp && has7) ? 'ok' : (dbUp ? 'muted' : 'off');

            // human-ish last sync
            var lastSync = js.last_sync_tfs_users ? new Date(js.last_sync_tfs_users).toLocaleString() : '—';

            // paint tiny status line
            box.innerHTML =
              '<span class="badge ' + badgeClass + '" aria-label="' + esc(badgeTxt) + '">' +
              esc(badgeTxt) +
              '</span> ' +
              'Last sync: ' + esc(lastSync) + ' · ' +
              'Today: ' + todayC + ' · 7d: ' + last7C;

            // optional: update the “Final TSV” link with suggested range
            var tsvFinal = byId('tsvFinal');
            if (tsvFinal && js.urls && js.urls.tsv_range) {
              tsvFinal.href = js.urls.tsv_range;
            }
          })
          .catch(function () {
            var box = byId("exportStatus");
            if (box) {
              box.innerHTML = '<span class="badge">Network error</span>';
            }
          });
      }


      document.addEventListener('DOMContentLoaded', function () {
        var codeSel = byId('code');
        if (codeSel) codeSel.addEventListener('change', syncNoteRequirement);
        syncNoteRequirement();

        var tkn = token();
        if (tkn) {
          fetch((API || location.origin) + "/api/me", { headers: { "Authorization": "Bearer " + tkn } })
            .then(function (res) { if (!res.ok) throw new Error('auth'); return res.json(); })
            .then(function (js) {
              setMe(js.email, js.name);
              var asn = byId("assigned"); if (asn && !asn.value && js.email) asn.value = js.email.split('@')[0];
              setRoleUI(js.role || 'dev');
              refreshIterationBadge();
              setStatus("loginStatus", "Logged in.");
            })
            .catch(function () { localStorage.removeItem(tokenKey); });
        }
      });
      initShortcuts();
      var tryLogin = function (e) { if (e.key === 'Enter') login(); };
      var lem = byId('loginEmail'); if (lem) lem.addEventListener('keydown', tryLogin);
      var lpw = byId('loginPw'); if (lpw) lpw.addEventListener('keydown', tryLogin);


      // Re-run requirement hint after <select id="code"> is populated by HTMX
      document.body.addEventListener('htmx:afterSwap', function (ev) {
        var tgt = ev.target || (ev.detail && ev.detail.target);
        if (tgt && tgt.id === 'code' && typeof syncNoteRequirement === 'function') {
          syncNoteRequirement();
        }
      });

      // expose globals for inline handlers
      window.signup = signup;
      window.login = login;
      window.logout = logout;
      window.loadTickets = loadTickets;
      window.prefill = prefill;
      window.submitProgress = submitProgress;
      window.lockDay = lockDay;
      window.loadMissing = loadMissing;
      window.pmUnlock = pmUnlock;
      window.loadBlockers = loadBlockers;
      window.loadToday = loadToday;
      window.openSPModal = openSPModal;
      window.closeSPModal = closeSPModal;
      window.loadReportRange = loadReportRange;
      window.presetReportThisWeek = presetReportThisWeek;
      window.presetReportThisMonth = presetReportThisMonth;


    })();
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</body>

</html>