<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>TFS Daily Updates â€” Iteration A (Login + Submit Day)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-weak: #e0e7ff;
      --success: #0a7a0a;
      --danger: #b00020;
      --table-head: #f6f6f6;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f17;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #111827;
        --border: #2d3648;
        --accent: #60a5fa;
        --accent-weak: #1f2937;
        --success: #22c55e;
        --danger: #ef4444;
        --table-head: #0f172a;
      }
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      margin: 8px 0 4px;
      font-size: 24px;
    }

    h3 {
      margin: 0 0 10px;
    }

    p {
      margin: 0 0 8px;
    }

    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      margin: 8px 0;
      align-items: center;
    }

    input,
    select,
    textarea {
      padding: 8px 10px;
      font-size: 14px;
      display: block;
      background: var(--card);
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    label {
      color: var(--muted);
    }

    button {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: white;
    }

    button.secondary {
      background: transparent;
      color: var(--fg);
    }

    button[disabled],
    a[disabled] {
      opacity: .6;
      pointer-events: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
      vertical-align: top;
    }

    th {
      background: var(--table-head);
      text-align: left;
    }

    tbody tr:hover {
      background: var(--accent-weak);
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-weak);
      color: var(--fg);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .card {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      margin: 14px 0;
      box-shadow: 0 1px 0 rgba(0, 0, 0, .04);
    }

    .hidden {
      display: none !important;
    }

    /* sticky footer action for Submit Progress */
    .sticky-actions {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status {
      margin-left: 8px;
      font-size: 13px;
    }

    .status.ok {
      color: var(--success);
    }

    .status.err {
      color: var(--danger);
    }

    .help {
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* simple skeleton row */
    .skeleton td {
      position: relative;
    }

    .skeleton td::after {
      content: "";
      display: block;
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, rgba(0, 0, 0, .06), rgba(0, 0, 0, .12), rgba(0, 0, 0, .06));
      animation: shimmer 1.2s infinite;
      margin: 8px 0;
    }

    @media (prefers-color-scheme: dark) {
      .skeleton td::after {
        background: linear-gradient(90deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .12), rgba(255, 255, 255, .05));
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200px 0
      }

      100% {
        background-position: 200px 0
      }
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* PM sections grid */
    .section-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }


    .card.thin {
      margin: 0;
      padding: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      z-index: 999;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open,
    .modal-backdrop.open {
      display: flex;
    }

    .modal-card {
      /* width: min(720px, 96vw); */
      width: min(50vw, 96vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .modal-body {
      padding: 14px;
      max-height: 70vh;
      overflow: auto;
    }

    .modal-foot {
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-close {
      background: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="card">
      <div class="toolbar" style="justify-content: space-between;">
        <div>
          <h1>TFS Daily Updates â€” v.1</h1>
          <p><span class="badge">POC</span> Login Â· My Tickets Â· Submit Day</p>
        </div>
        <div class="pill">
          <span id="me"></span>
          <button id="logoutBtn" class="hidden secondary" title="Sign out" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <section class="card" id="loginCard">
      <h3>Login</h3>
      <div class="row"><label for="loginEmail">Email</label><input id="loginEmail" placeholder="dev@company.com"
          autocomplete="username" /></div>
      <div class="row"><label for="loginPw">Password</label><input id="loginPw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
          autocomplete="current-password" /></div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button onclick="signup()">Sign Up</button>
          <button onclick="login()">Log In</button>
          <span id="loginStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </section>

    <section class="card hidden" id="ticketsCard">
      <h3>My Tickets</h3>
      <div id="findFilters">
        <div class="row"><label for="assigned">Assigned to</label><input id="assigned"
            placeholder="email or domain\alias" /></div>
        <div class="row"><label for="q">Contains</label><input id="q" placeholder="search title/id (optional)" /></div>
      </div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button id="loadBtn" onclick="loadTickets()">Load</button>
          <span id="loadStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
      <table id="ticketsTbl" aria-live="polite">
        <thead>
          <tr>
            <th style="width:100px">ID</th>
            <th style="width:350px">Title</th>
            <th style="width:120px">State</th>
            <th style="width:75x">Code</th>
            <th>Note</th>
            <th style="width:75px">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card hidden" id="submitCard">
      <h3>Submit Progress</h3>
      <div class="row"><label for="tId">Ticket ID</label><input id="tId" inputmode="numeric" /></div>
      <div class="row"><label for="code">Progress Code</label>
        <select id="code" hx-get="/api/ui/progress-codes/options" hx-trigger="load" hx-swap="innerHTML">
        </select>
      </div>
      <div class="row"><label for="note">Note</label><textarea id="note" rows="3"
          placeholder="short, concrete update"></textarea></div>
      <div class="row"><label>&nbsp;</label><small id="noteHint" class="help">
          A note may be required for some codes.
        </small></div>

      <div class="row">
        <div></div>
        <div class="toolbar">
          <button id="submitBtn" onclick="submitProgress()">Submit</button>
          <span id="submitStatus" class="status" role="status" aria-live="polite"></span>

        </div>
        <div></div>
      </div>
      <div class="sticky-actions">
        <div class="row">
          <label>
            <button class="secondary" onclick="lockDay()">Submit Day</button>
            <span id="lockStatus" class="status" role="status" aria-live="polite" style="display: inline-block;"></span>
          </label>
          <p>Submit Day locks in your updates for today so PMs can
            finalize the report. After locking, only a PM can
            unlock
            you.</p>
        </div>

      </div>

    </section>

    <section id="pm" class="card hidden" data-role="pm-only" aria-labelledby="pmHeader">
      <div class="section-grid">
        <!-- (1) Pre-Meeting Updates -->
        <section class="card thin" aria-labelledby="preHeader">
          <h4 id="preHeader">Pre-Meeting Updates</h4>
          <div id="today"></div>
        </section>

        <!-- (2) Who hasn't updated yet -->
        <section class="card thin" aria-labelledby="missingHeader">
          <h4 id="missingHeader">Who hasn't updated yet</h4>
          <div class="row">
            <div></div>
            <div class="toolbar">
              <button onclick="loadMissing()">Refresh</button>
            </div>
          </div>
          <div id="missing"></div>
        </section>

        <!-- (3) Unlock a user -->
        <section class="card thin" aria-labelledby="unlockHeader">
          <h4 id="unlockHeader">Unlock a user</h4>
          <div class="row">
            <label for="unlockEmail">User email</label>
            <input id="unlockEmail" placeholder="dev@company.com" />
          </div>
          <div class="row">
            <div></div>
            <div class="toolbar">
              <button onclick="pmUnlock()">Unlock</button>
              <span id="unlockStatus" class="status" role="status" aria-live="polite"></span>
            </div>
          </div>
        </section>

        <!-- (4) Download TSV links -->
        <section class="card thin" aria-labelledby="downloadHeader">
          <h4 id="downloadHeader">Pre-Meeting Downloads</h4>
          <div class="row">
            <div></div>
            <div class="toolbar">
              <a id="tsvLive" href="/api/updates/today.tsv" target="_blank">Download Live TSV</a>
              <span>Â·</span>
              <a id="tsvFinal" href="/api/exports/today" target="_blank">Download Final TSV</a>
              <span id="exportStatus" class="status" role="status" aria-live="polite"></span>
            </div>
          </div>
        </section>

        <!-- (5) Blockers radar -->
        <section class="card thin" aria-labelledby="blockersHeader">
          <h4 id="blockersHeader">Blockers Radar</h4>
          <div class="row">
            <div></div>
            <div class="toolbar">
              <button onclick="loadBlockers()">Refresh</button>
            </div>
          </div>
          <div id="blockers"></div>
        </section>
      </div>

    </section>

    <!-- Submit Progress Modal -->
    <div id="spBackdrop" class="modal-backdrop" onclick="closeSPModal()"></div>
    <div id="spModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="spTitle">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-head">
          <h3 id="spTitle">Submit Progress</h3>
          <button class="modal-close" onclick="closeSPModal()" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="row"><label for="tId">Ticket ID</label><input id="tId" inputmode="numeric" /></div>
          <div class="row">
            <label for="code">Progress Code</label>
            <select id="code" hx-get="/api/ui/progress-codes/options" hx-trigger="load" hx-swap="innerHTML"></select>
          </div>
          <div class="row"><label for="note">Note</label><textarea id="note" rows="4"
              placeholder="short, concrete update"></textarea></div>
          <div class="row"><label>&nbsp;</label><small id="noteHint" class="help">A note may be required for some
              codes.</small></div>
        </div>
        <div class="modal-foot">
          <button class="secondary" onclick="closeSPModal()">Cancel</button>
          <button id="submitBtn" onclick="submitProgress()">Submit</button>
          <span id="submitStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>


  </div>

  <script>
    (function () {
      // ES5-compatible script (no arrow fns, no optional chaining, no template strings)
      var API = "";
      var tokenKey = "pocToken";

      function byId(id) { return document.getElementById(id); }

      function setStatus(id, msg, ok) {
        if (ok === void 0) ok = true;
        var el = byId(id);
        if (!el) return;
        el.classList.remove('ok');   // remove old state
        el.classList.remove('err');
        el.classList.add('status');
        el.classList.add(ok ? 'ok' : 'err');
        el.textContent = msg || '';
      }


      function token() { return localStorage.getItem(tokenKey) || ""; }

      function esc(s) {
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        s = (s == null) ? "" : String(s);
        return s.replace(/[&<>"']/g, function (c) { return map[c]; });
      }

      function requiresNote(code) {
        var sel = document.getElementById('code');
        if (!sel) return false;
        var opt = sel.querySelector('option[value="' + code + '"]');
        return !!(opt && opt.getAttribute('data-requirenote') === 'true');
      }


      function clearForNewSession() {
        var ids = ['loginStatus', 'loadStatus', 'submitStatus', 'lockStatus', 'exportStatus', 'unlockStatus'];
        for (var i = 0; i < ids.length; i++) { var el = byId(ids[i]); if (el) el.textContent = ''; }
        var le = byId('loginEmail'); if (le) le.value = '';
        var lp = byId('loginPw'); if (lp) lp.value = '';
        var tId = byId('tId'); if (tId) tId.value = '';
        var codeSel = byId('code'); if (codeSel) codeSel.selectedIndex = 0;
        var note = byId('note'); if (note) note.value = '';
        var assigned = byId('assigned'); if (assigned) assigned.value = '';
        var q = byId('q'); if (q) q.value = '';
        var filters = byId('findFilters'); if (filters) filters.style.display = '';
        var tbody = document.querySelector('#ticketsTbl tbody'); if (tbody) tbody.innerHTML = '';
        var sec = ['today', 'blockers', 'missing'];
        for (var j = 0; j < sec.length; j++) { var el2 = byId(sec[j]); if (el2) el2.innerHTML = ''; }
      }

      function setMe(email, name) {
        var assigned = byId("assigned");
        if (assigned && !assigned.value && email) {
          assigned.value = String(email).split("@")[0];
        }
        var me = byId("me");
        me.textContent = email ? ("Logged in as: " + (name || email)) : "";
        var btn = byId("logoutBtn");
        if (btn) btn.classList.toggle("hidden", !email);

        if (!email) {
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        }
      }

      function setRoleUI(role) {
        var isPM = (role === 'pm');
        var loginCard = byId('loginCard');
        var ticketsCard = byId('ticketsCard');
        var submitCard = byId('submitCard');
        var pmBox = byId('pm');

        if (loginCard) loginCard.classList.add('hidden');
        if (ticketsCard) ticketsCard.classList.remove('hidden');
        if (submitCard) submitCard.classList.remove('hidden');
        if (pmBox) pmBox.classList.toggle('hidden', !isPM);

        if (pmBox) {
          var controls = pmBox.querySelectorAll('button, a');
          for (var i = 0; i < controls.length; i++) {
            if (!isPM) controls[i].setAttribute('disabled', 'disabled');
            else controls[i].removeAttribute('disabled');
          }
        }

        var me = byId("me");
        if (me) {
          var txt = me.textContent;
          me.innerHTML = esc(txt);
          var badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = isPM ? 'PM' : 'DEV';
          me.appendChild(document.createTextNode(' '));
          me.appendChild(badge);
        }

        var filters = byId('findFilters');
        if (isPM) {
          if (filters) filters.style.display = '';
          loadToday(); loadBlockers(); loadMissing(); loadExportStatus();
          if (!window.__exportTimer) {
            window.__exportTimer = setInterval(function () {
              var pmEl = byId('pm');
              if (pmEl && !pmEl.classList.contains('hidden')) { loadExportStatus(); }
            }, 60000);
          }
        } else {
          if (filters) filters.style.display = 'none';
          loadTickets();
        }
      }

      function syncNoteRequirement() {
        var code = byId('code').value;
        var note = byId('note');
        var hint = byId('noteHint');
        var need = requiresNote(code);
        note.required = !!need;
        hint.style.fontWeight = need ? '600' : '400';
        hint.style.opacity = need ? '1' : '.7';
      }

      function req(method, url, body, headers) {
        var opts = { method: method, headers: headers || {} };
        if (body != null) opts.body = body;
        return fetch(url, opts).then(function (res) { return res.json(); });
      }

      function signup() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Signing up...");
        req('POST', (API || location.origin) + "/api/auth/signup", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) { if (js.error) setStatus("loginStatus", js.error, false); else setStatus("loginStatus", "Account created. Please login."); })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function login() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Logging in...");
        req('POST', (API || location.origin) + "/api/auth/login", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) {
            if (js.error) { setStatus("loginStatus", js.error, false); return; }
            clearForNewSession();
            localStorage.setItem(tokenKey, js.token);
            setMe(js.email, js.name);
            setRoleUI(js.role || 'dev');
            setStatus("loginStatus", "Logged in.");
          })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function logout(all) {
        if (all === void 0) all = false;
        var t = localStorage.getItem("pocToken");
        var done = function () {
          localStorage.removeItem("pocToken");
          clearForNewSession();
          setMe("", "");
          setStatus("loginStatus", "Logged out.");
          var lb = byId("logoutBtn"); if (lb) lb.classList.add("hidden");
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        };
        if (t) {
          req('POST', (API || location.origin) + (all ? "/api/auth/logout_all" : "/api/auth/logout"), null, { "Authorization": "Bearer " + t }).then(function () { done(); }).catch(function () { done(); });
        } else { done(); }
      }

      function loadTickets() {
        var assigned = byId("assigned");
        var q = byId("q");
        var btn = byId("loadBtn");
        var status = byId("loadStatus");
        status.textContent = "Loading...";
        btn.disabled = true;

        var tbody = document.querySelector("#ticketsTbl tbody");
        tbody.innerHTML = "";
        for (var i = 0; i < 5; i++) {
          var tr = document.createElement('tr'); tr.className = 'skeleton';
          tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td>';

          tbody.appendChild(tr);
        }
        var url = new URL((API || location.origin) + "/api/tickets");
        if (assigned && assigned.value.trim()) url.searchParams.set("assignedTo", assigned.value.trim());
        if (q && q.value.trim()) url.searchParams.set("q", q.value.trim());
        var hdrs = {};
        var tkn = localStorage.getItem("pocToken");
        if (tkn) hdrs["Authorization"] = "Bearer " + tkn;

        fetch(url, { headers: hdrs })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            status.textContent = "Loaded " + (js.count || 0) + " ticket(s)";
            tbody.innerHTML = "";
            var items = js.items || [];
            for (var k = 0; k < items.length; k++) {
              var t = items[k];
              var tr2 = document.createElement("tr");
              tr2.setAttribute("data-id", String(t.id));
              var code = t.lastCode || t.progressCode || t.code || '';
              var note = t.lastNote || t.progressNote || t.note || '';
              tr2.innerHTML =
                '<td>' + esc(t.id) + '</td>' +
                '<td><i>' + esc(t.title) + '</i></td>' +
                '<td>' + esc(t.state) + '</td>' +
                '<td>' + esc(code || 'â€”') + '</td>' +
                '<td>' + esc(note || 'â€”') + '</td>' +
                '<td><button class="secondary" onclick="openSPModal(' + Number(t.id) + ')" aria-label="Select ticket ' + esc(t.id) + '">Select</button></td>';

              tbody.appendChild(tr2);
            }
          })
          .catch(function () {
            status.textContent = "Failed to load";
            status.classList.add('err');
            tbody.innerHTML = '<tr><td colspan="6">Unable to load tickets. Check network or try again.</td></tr>';
          })
          .finally(function () { btn.disabled = false; });
      }

      function openSPModal(id) {
        var m = byId('spModal'), b = byId('spBackdrop');
        if (id != null) byId('tId').value = String(id);
        // ensure note-required hint is correct (HTMX may have just populated options)
        if (window.syncNoteRequirement) syncNoteRequirement();
        m.classList.add('open'); b.classList.add('open');
        // focus first field
        setTimeout(function () { var t = byId('tId'); if (t) t.focus(); }, 0);
      }

      function closeSPModal() {
        var m = byId('spModal'), b = byId('spBackdrop');
        m.classList.remove('open'); b.classList.remove('open');
      }

      // ESC to close
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') { closeSPModal(); }
      });

      // after a successful submit, we already update the row inline;
      // also close the modal there:


      function prefill(id) {
        byId("tId").value = id;
        byId('submitCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function submitProgress() {
        var tkn = token();
        if (!tkn) { setStatus("submitStatus", "Please login first.", false); return; }
        var ticket = byId("tId").value.trim();
        var code = byId("code").value;
        var note = byId("note").value.trim();
        if (!ticket) { setStatus("submitStatus", "Ticket ID is required.", false); return; }
        if (requiresNote(code) && !note) { setStatus("submitStatus", "A note is required for this code.", false); return; }
        setStatus("submitStatus", "Submitting...");
        var btn = byId('submitBtn'); btn.disabled = true;
        req('POST', (API || location.origin) + "/api/progress", JSON.stringify({ ticketId: ticket, code: code, note: note }), { "Content-Type": "application/json", "Authorization": "Bearer " + tkn })
          .then(function (js) {
            if (js && js.error) setStatus("submitStatus", js.error, false); else {
              setStatus("submitStatus", "Saved!");
              byId("note").value = "";
              closeSPModal();
              // Optimistically update the row in My Tickets
              var row = document.querySelector('#ticketsTbl tbody tr[data-id="' + ticket + '"]');
              if (row) {
                var cells = row.getElementsByTagName('td');
                // columns: [0]=ID, [1]=Title, [2]=State, [3]=Code, [4]=Note, [5]=Action
                if (cells[3]) cells[3].textContent = code || 'â€”';
                if (cells[4]) cells[4].textContent = note || 'â€”';
              } else {
                // if the table isn't loaded yet or row not found, just refresh
                if (typeof loadTickets === 'function') { loadTickets(); }
              }

            }
          })
          .catch(function () { setStatus("submitStatus", "Network error", false); })
          .finally(function () { btn.disabled = false; });
      }

      function lockDay() {
        var tkn = token();
        if (!tkn) { setStatus("lockStatus", "Please login first.", false); return; }
        setStatus("lockStatus", "Submitting day...");
        req('POST', (API || location.origin) + "/api/updates/lock", null, { "Authorization": "Bearer " + tkn })
          .then(function (js) {
            if (js.error) setStatus("lockStatus", js.error, false);
            else setStatus("lockStatus", js.locked ? "Day submitted (locked)" : "Not locked", !!js.locked);
            if (js.locked) { var badgeEl = byId("me").querySelector('.badge'); var txt = badgeEl ? badgeEl.textContent : ''; if (txt === 'PM') { loadToday(); loadBlockers(); loadMissing(); } }
          })
          .catch(function () { setStatus("lockStatus", "Network error", false); });
      }

      function loadToday() {
        var box = byId("today");
        fetch((API || location.origin) + "/api/updates/today")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var out = [];
            out.push('<span class="badge">' + esc(js.date || "") + "</span>");

            var users = js.users || [];
            for (var u = 0; u < users.length; u++) {
              var user = users[u];

              // Use HTML entities for lock icons to avoid encoding issues
              var lock = user.locked ? "&#128274;" /* locked */ : "&#128275;" /* unlocked */;
              var who = user.name
                ? (esc(user.name) + " <small>(" + esc(user.email) + ")</small>")
                : esc(user.email);

              out.push("<h3>" + lock + " " + who + "</h3>");

              // group by assignedTo (alias bucket)
              var groups = {};
              var uts = user.tickets || [];
              for (var t = 0; t < uts.length; t++) {
                var it = uts[t];
                var key = (it.assignedTo && String(it.assignedTo).trim()) ? it.assignedTo : "(unassigned)";
                if (!groups[key]) { groups[key] = []; }
                groups[key].push(it);
              }

              var keys = Object.keys(groups).sort(function (a, b) { return a.localeCompare(b); });
              if (keys.length === 0) {
                out.push("<p><em>No updates yet today.</em></p>");
              } else {
                for (var k = 0; k < keys.length; k++) {
                  var gk = keys[k];
                  out.push("<h4>## " + esc(gk) + " ##</h4>");

                  // table
                  out.push('<table class="today-grid">');
                  out.push("<thead><tr>");
                  out.push('<th style="width:75px">ID</th>');
                  out.push('<th style="width:350px">Title</th>');
                  out.push('<th style="width:120px">State</th>');
                  out.push('<th style="width:75px">Code</th>');
                  out.push("<th>Note</th>");

                  out.push("</tr></thead><tbody>");

                  var arr = groups[gk];
                  for (var m = 0; m < arr.length; m++) {
                    var it2 = arr[m];
                    out.push("<tr>");
                    out.push("<td>" + esc(it2.ticketId) + "</td>");
                    out.push("<td><i>" + esc(it2.title) + "</i></td>");
                    out.push("<td>" + esc(it2.state) + "</td>");
                    out.push("<td>" + esc(it2.code) + "</td>");
                    out.push("<td>" + esc(it2.note) + "</td>");

                    out.push("</tr>");
                  }

                  out.push("</tbody></table>");
                }
              }
            }

            box.innerHTML = out.join("");
          });
      }

      function loadBlockers() {
        var box = byId("blockers");
        fetch((API || location.origin) + "/api/updates/blockers")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            function sev(c) { return c && c.indexOf('600_') === 0 ? 0 : c && c.indexOf('700_') === 0 ? 1 : c && c.indexOf('800_') === 0 ? 2 : 3; }
            var items = js.items || [];
            var groups = {};
            for (var i = 0; i < items.length; i++) {
              var h = items[i];
              var k = (h.assignedTo && h.assignedTo.trim()) ? h.assignedTo : "(unassigned)";
              if (!groups[k]) groups[k] = [];
              groups[k].push(h);
            }
            var html = '<p><span class="badge">' + esc(js.date || "") + '</span></p>';
            var keys = Object.keys(groups).sort(function (a, b) { return a.localeCompare(b); });
            if (keys.length === 0) { box.innerHTML = html + '<p><em>No blockers detected today.</em></p>'; return; }
            for (var j = 0; j < keys.length; j++) {
              var key = keys[j];
              groups[key].sort(function (a, b) { return sev(a.code) - sev(b.code) || String(b.at || "").localeCompare(String(a.at || "")); });
              html += '<h4>## ' + esc(key) + ' ##</h4><ul>';
              var arr = groups[key];
              for (var n = 0; n < arr.length; n++) {
                var hh = arr[n];
                html += '<li>' + esc(hh.ticketId) + ' - <i>' + esc(hh.title) + '</i> - ' + esc(hh.state) + ' - ' + esc(hh.code) + ' - ' + esc(hh.note) + ' - ' + esc(hh.iterationPath) + '</li>';
              }
              html += '</ul>';
            }
            box.innerHTML = html;
          });
      }

      function loadMissing() {
        var box = byId("missing");
        fetch((API || location.origin) + "/api/updates/missing", { headers: { "Authorization": "Bearer " + (localStorage.getItem("pocToken") || "") } })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            if (js.error) { box.innerHTML = '<p class="status err">' + esc(js.error) + '</p>'; return; }
            if (!js.missing || js.missing.length === 0) { box.innerHTML = '<p><span class="badge">' + esc(js.date || "") + '</span> â€” everyone has updated ðŸŽ‰</p>'; return; }
            var html = '<p><span class="badge">' + esc(js.date || "") + '</span> â€” ' + js.count + ' dev(s) with no update</p><ul>';
            for (var i = 0; i < js.missing.length; i++) { var m = js.missing[i]; html += '<li>' + esc(m.label) + ' <small>(' + esc(m.email) + ')</small></li>'; }
            html += '</ul>';
            box.innerHTML = html;
          });
      }

      function pmUnlock() {
        var email = byId("unlockEmail").value.trim();
        var tkn = localStorage.getItem("pocToken") || "";
        if (!tkn) { setStatus("unlockStatus", "Please login", false); return; }
        setStatus("unlockStatus", "Unlocking...");
        req('POST', (API || location.origin) + "/api/updates/unlock", JSON.stringify({ email: email }), { "Content-Type": "application/json", "Authorization": "Bearer " + tkn })
          .then(function (js) { if (js.error) setStatus("unlockStatus", js.error, false); else setStatus("unlockStatus", 'Unlocked ' + js.target, true); })
          .catch(function () { setStatus("unlockStatus", "Network error", false); });
      }

      function loadExportStatus() {
        var tkn = localStorage.getItem("pocToken") || "";
        if (!tkn) return;
        fetch((API || location.origin) + "/api/exports/status", { headers: { "Authorization": "Bearer " + tkn } })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var box = byId("exportStatus");
            if (js.error) { box.textContent = ""; return; }
            var msg = (js.lockedUpdaters || 0) + '/' + (js.totalUpdaters || 0) + ' locked â€” ' + (js.ready ? 'Final ready' : 'Final not ready');
            box.innerHTML = '<span class="badge">' + esc(js.date || '') + '</span> ' + msg;
          });
      }

      document.addEventListener('DOMContentLoaded', function () {
        var codeSel = byId('code');
        if (codeSel) codeSel.addEventListener('change', syncNoteRequirement);
        syncNoteRequirement();

        var tkn = token();
        if (tkn) {
          fetch((API || location.origin) + "/api/me", { headers: { "Authorization": "Bearer " + tkn } })
            .then(function (res) { if (!res.ok) throw new Error('auth'); return res.json(); })
            .then(function (js) {
              setMe(js.email, js.name);
              var asn = byId("assigned"); if (asn && !asn.value && js.email) asn.value = js.email.split('@')[0];
              setRoleUI(js.role || 'dev');
              setStatus("loginStatus", "Logged in.");
            })
            .catch(function () { localStorage.removeItem(tokenKey); });
        }
      });

      // Re-run requirement hint after <select id="code"> is populated by HTMX
      document.body.addEventListener('htmx:afterSwap', function (ev) {
        var tgt = ev.target || (ev.detail && ev.detail.target);
        if (tgt && tgt.id === 'code' && typeof syncNoteRequirement === 'function') {
          syncNoteRequirement();
        }
      });

      // expose globals for inline handlers
      window.signup = signup;
      window.login = login;
      window.logout = logout;
      window.loadTickets = loadTickets;
      window.prefill = prefill;
      window.submitProgress = submitProgress;
      window.lockDay = lockDay;
      window.loadMissing = loadMissing;
      window.pmUnlock = pmUnlock;
      window.loadBlockers = loadBlockers;
      window.loadToday = loadToday;
      window.openSPModal = openSPModal;
      window.closeSPModal = closeSPModal;

    })();
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</body>

</html>