<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>TFS Daily Updates — v.1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-weak: #e0e7ff;
      --success: #0a7a0a;
      --danger: #b00020;
      --table-head: #f6f6f6;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f17;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #111827;
        --border: #2d3648;
        --accent: #60a5fa;
        --accent-weak: #1f2937;
        --success: #22c55e;
        --danger: #ef4444;
        --table-head: #0f172a;
      }
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: min(1400px, 96vw);
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      margin: 8px 0 4px;
      font-size: 24px;
    }

    h3 {
      margin: 0 0 10px;
    }

    p {
      margin: 0 0 8px;
    }

    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      margin: 8px 0;
      align-items: center;
    }

    input,
    select,
    textarea {
      padding: 8px 10px;
      font-size: 14px;
      display: block;
      background: var(--card);
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    select {
      width: 100%;
    }

    label {
      color: var(--muted);
    }

    button {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: white;
    }

    button.secondary {
      background: transparent;
      color: var(--fg);
    }

    button.small {
      padding: 4px 8px;
      font-size: 12px;
    }


    button[disabled],
    a[disabled] {
      opacity: .6;
      pointer-events: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
      vertical-align: top;
    }

    th {
      background: var(--table-head);
      text-align: left;
    }

    tbody tr:hover {
      background: var(--accent-weak);
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-weak);
      color: var(--fg);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .card {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      margin: 14px 0;
      box-shadow: 0 1px 0 rgba(0, 0, 0, .04);
    }

    .hidden {
      display: none !important;
    }

    /* sticky footer action for Submit Progress */
    .sticky-actions {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status {
      margin-left: 8px;
      font-size: 13px;
    }

    .status.ok {
      color: var(--success);
    }

    .status.err {
      color: var(--danger);
    }

    .help {
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* simple skeleton row */
    .skeleton td {
      position: relative;
    }

    .skeleton td::after {
      content: "";
      display: block;
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, rgba(0, 0, 0, .06), rgba(0, 0, 0, .12), rgba(0, 0, 0, .06));
      animation: shimmer 1.2s infinite;
      margin: 8px 0;
    }

    @media (prefers-color-scheme: dark) {
      .skeleton td::after {
        background: linear-gradient(90deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .12), rgba(255, 255, 255, .05));
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200px 0
      }

      100% {
        background-position: 200px 0
      }
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Keep the snapshots controls on one row and let the select expand */
    .row>.snapshots-toolbar {
      width: 100%;
      /* make the flex container fill the grid cell */
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      /* single row */
    }

    #snapDev {
      flex: 1 1 0%;
      /* grow + shrink; 0% basis makes it actually expand */
      width: 100%;
      /* fill the grown flex item */
      min-width: 260px;
      /* your floor */
      max-width: 100%;
    }

    .snapshots-toolbar>button {
      flex: 0 0 auto;
      /* buttons keep natural size */
      white-space: nowrap;
    }

    /* Optional: allow wrapping on very small screens */
    @media (max-width: 640px) {
      .row>.snapshots-toolbar {
        flex-wrap: wrap;
      }

      #snapDev {
        flex-basis: 100%;
      }
    }


    /* override global select { width:100% } */

    /* PM sections grid */
    .section-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }



    .card.thin {
      margin: 0;
      padding: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      z-index: 999;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open,
    .modal-backdrop.open {
      display: flex;
    }

    .modal-card {
      width: min(50vw, 96vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .modal-body {
      padding: 14px;
      max-height: 70vh;
      overflow: auto;
    }

    .modal-foot {
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-close {
      background: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 18px;
      font-weight: 600;
      background: #e5e7eb;
      color: #111827;
      vertical-align: baseline;
    }

    .badge.ok {
      background: #22c55e;
      color: #ffffff;
    }

    .badge.muted {
      background: #9ca3af;
      color: #111827;
    }

    .badge.off {
      background: #ef4444;
      color: #ffffff;
    }

    .badge.release {
      background: #f28c1b;
      color: #ffffff
    }

    /* Code family badges */
    .badge.code-100,
    .badge.code-200,
    .badge.code-300,
    .badge.code-400 {
      background: var(--accent-weak);
      color: var(--fg);
    }

    .badge.code-500 {
      background: #16a34a;
      color: #ffffff;
    }

    .badge.code-600 {
      background: #f59e0b;
      color: #111827;
    }

    .badge.code-700 {
      background: #eab308;
      color: #111827;
    }

    .badge.code-800 {
      background: #ef4444;
      color: #ffffff;
    }

    /* Desktop: PM grid in 2 columns */
    @media (min-width: 1024px) {
      .section-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Sticky header for My Tickets */
    #ticketsTbl thead th {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* PM: two equal-width columns */
    .pm-2col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      align-items: start;
    }

    .pm-2col>div {
      min-width: 0;
    }

    @media (max-width: 900px) {
      .pm-2col {
        grid-template-columns: 1fr;
      }
    }

    .toolbar.right {
      justify-content: flex-end;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      align-items: center;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .field input {
      width: 100%;
    }

    @media (max-width: 800px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .pre-list {
      display: grid;
      gap: 14px;
    }

    @media (min-width: 1100px) {
      .pre-list {
        grid-template-columns: 1fr;
      }
    }

    .pre-user {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--card);
    }

    .pre-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      background: var(--table-head);
      border-bottom: 1px solid var(--border);
    }

    .pre-ident {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .pre-title {
      font-weight: 600;
    }

    .pre-meta {
      color: var(--muted);
      font-size: 12px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      font-weight: 700;
      background: var(--accent-weak);
      color: var(--fg);
    }

    .subgroup {
      padding: 8px 12px;
      border-top: 1px dashed var(--border);
      color: var(--muted);
      font-weight: 600;
    }

    .today-grid {
      margin: 0;
      border-top: 0;
    }

    .today-grid th,
    .today-grid td {
      font-size: 12.5px;
    }

    .state-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
    }

    /* --- NEW: AI risk chips --- */
    .badge.risk-1 {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.risk-2 {
      background: #bfdbfe;
      color: #1e3a8a;
    }

    .badge.risk-3 {
      background: #fde68a;
      color: #78350f;
    }

    .badge.risk-4 {
      background: #fca5a5;
      color: #7f1d1d;
    }

    .badge.risk-5 {
      background: #ef4444;
      color: #ffffff;
    }

    .badge.risk-low {
      background: #dcfce7;
      color: #166534;
    }

    .badge.risk-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.risk-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.slip-high {
      background: #ef4444;
      color: #ffffff;
    }

    .badge.slip-medium {
      background: #f59e0b;
      color: #111827;
    }

    .badge.slip-low {
      background: #10b981;
      color: #ffffff;
    }

    .muted {
      color: var(--muted);
    }

    .ai-rationale {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="card">
      <div class="toolbar" style="justify-content: space-between;">
        <div>
          <h1>TFS Daily Updates — v.1</h1>

          <p><span class="badge">BETA</span> A lightweight ledger of daily ticket progress to spot blockers and track
            momentum.</p>
        </div>
        <div class="pill">
          <span id="me"></span>
          <button id="logoutBtn" class="hidden secondary" title="Sign out" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <section class="card" id="loginCard">
      <h3>Login</h3>
      <div class="row"><label for="loginEmail">Email</label><input id="loginEmail" placeholder="dev@company.com"
          autocomplete="username" /></div>
      <div class="row"><label for="loginPw">Password</label><input id="loginPw" type="password" placeholder="••••••"
          autocomplete="current-password" /></div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button onclick="signup()">Sign Up</button>
          <button onclick="login()">Log In</button>
          <span id="loginStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </section>

    <section class="card hidden" id="ticketsCard">
      <h3>My Tickets <small id="iterLabel" class="badge muted" title="Active iteration">—</small></h3>
      <div id="findFilters">
        <div class="row"><label for="assigned">Assigned to</label><input id="assigned"
            placeholder="email or domain\alias" /></div>
        <div class="row"><label for="q">Contains</label><input id="q" placeholder="search title/id (optional)" /></div>
      </div>
      <div class="row">
        <div></div>
        <div class="toolbar">
          <button id="loadBtn" onclick="loadTickets()">Load</button>
          <span id="loadStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
      <table id="ticketsTbl" aria-live="polite">
        <thead>
          <tr>
            <th style="width:100px">ID</th>
            <th style="width:110px">Type</th>
            <th style="width:350px">Title</th>
            <th style="width:120px">State</th>
            <th style="width:120px">Severity</th>
            <th style="width:75px">Code</th>
            <th>Note</th>
            <th style="width:75px">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <section class="card thin" id="weeklySummaryCard" aria-labelledby="weeklySummaryHeader"
        style="margin-top:12px;">
        <div class="row">
          <h3 id="weeklySummaryHeader" style="margin:0">Weekly Summary</h3>
          <div class="toolbar right">
            <button class="secondary" onclick="loadWeeklySummary()">Refresh</button>
            <span id="weeklySummaryStatus" class="status" role="status" aria-live="polite"></span>
          </div>
        </div>
        <div id="weeklySummaryBody" class="help">Log in to see your last 7 days of progress.</div>
      </section>
      <section id="submitCard" aria-labelledby="spHeader">
        <h3 style="margin-top: 1.33rem;">Submit Progress</h3>

        <div class="sticky-actions">
          <div class="row">
            <label>
              <button class="secondary" onclick="lockDay()">Update Complete</button>
              <span id="lockStatus" class="status" role="status" aria-live="polite"
                style="display: inline-block;"></span>
            </label>
            <p>This locks in your updates for today so PMs can
              finalize the report. After locking, only a PM can
              unlock
              you.</p>
          </div>

        </div>
      </section>
    </section>

    <section id="pm" class="card hidden" data-role="pm-only" aria-labelledby="pmHeader">
      <div class="section-grid">
        <!-- (1) Pre-Meeting Updates -->
        <section class="card thin" aria-labelledby="preHeader">
          <div class="row">
            <h3 id="preHeader" style="margin:0">Pre-Meeting Updates</h3>
            <div class="toolbar right">
              <button id="aiRiskToggle" class="secondary" onclick="toggleAiRisk()">AI Risk Rationale</button>
              <span id="aiRiskStatus" class="status" role="status" aria-live="polite"></span>
            </div>
          </div>
          <div id="today"></div>
        </section>

        <!-- (2) Who hasn't updated yet -->
        <section class="card thin" aria-labelledby="missingHeader">
          <h3 id="missingHeader">Who hasn't updated yet</h3>
          <div id="missing"></div>
          <div class="toolbar">
            <button onclick="loadMissing()">Refresh</button>
          </div>
        </section>


        <!-- Report -->
        <section class="card thin" aria-labelledby="reportsHeader">
          <div class="row">
            <h3 id="reportsHeader" style="margin:0; max-width: fit-content;">Reports</h3>
            <div class="toolbar right">
              <button onclick="presetReportThisWeek(true)">This week</button>
              <button onclick="presetReportThisMonth(true)">This month</button>
              <button onclick="loadReportRange()">Load</button>
              <a id="dlRange" class="secondary" target="_blank" href="/api/updates/range.tsv">Download TSV</a>
            </div>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="repFrom">From</label>
              <input id="repFrom" type="date" />
            </div>
            <div class="field">
              <label for="repTo">To</label>
              <input id="repTo" type="date" />
            </div>
          </div>

          <!-- Developer Snapshots -->
          <div class="row" style="margin-top:10px;">
            <label for="snapDev">Assigned to</label>
            <div class="toolbar snapshots-toolbar">
              <select id="snapDev">
                <option value="all">— Select developer —</option>
              </select>
              <button class="secondary" onclick="reloadSnapshotDevList()">Reload</button> <!-- NEW -->
              <button type="button" onclick="openSnapshots('html')">Preview (HTML)</button>
              <button type="button" onclick="openSnapshots('pdf')">Download PDF</button>
              <button type="button" onclick="emailSnapshots()">Email Snapshot</button>
            </div>
          </div>


          <div class="table-wrap">
            <table id="reportTbl">
              <thead>
                <tr>
                  <th style="width:110px">Date</th>
                  <th style="width:140px">Assigned to</th>
                  <th style="width:100px">Ticket</th>
                  <th style="width:110px">Type</th>
                  <th>Title</th>
                  <th style="width:120px">State</th>
                  <th style="width:120px">Code</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>


        </section>

        <!-- (5) Blockers radar -->
        <section class="card thin" aria-labelledby="blockersHeader">
          <div class="row">
            <h3 id="blockersHeader" style="margin:0">Blockers Radar</h3>
            <div class="toolbar right">
              <button onclick="loadBlockers()">Refresh</button>
              <span id="aiStatus" class="status" role="status" aria-live="polite"></span>
            </div>
          </div>

          <div class="table-wrap">
            <table id="blockersTbl" aria-live="polite">
              <thead>
                <tr>
                  <th style="width:100px">ID</th>
                  <th style="width:110px">Type</th>
                  <th style="width:350px">Title</th>
                  <th style="width:120px">State</th>
                  <th style="width:100px">Code</th>
                  <th style="width:90px">Risk</th>
                  <th>Note</th>
                  <th style="width:180px">Iteration</th>
                  <th style="width:110px">AI</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="triagePanel" class="card thin hidden" aria-labelledby="triageHeader" style="margin-top:12px;">
              <h3 id="triageHeader" style="margin:0">AI Triage — prioritized next steps</h3>
              <ol id="triage-list" style="margin-top:10px;"></ol>
            </div>
          </div>
        </section>

      </div>
    </section>

    <!-- Submit Progress Modal -->
    <div id="spBackdrop" class="modal-backdrop" onclick="closeSPModal()"></div>
    <div id="spModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="spTitle">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-head">
          <h3 id="spTitle">Submit Progress</h3>
          <button class="modal-close" onclick="closeSPModal()" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="row"><label for="tId">Ticket ID</label><input id="tId" inputmode="numeric" /></div>
          <div class="row">
            <label for="code">Progress Code</label>
            <select id="code" hx-get="/api/ui/progress-codes/options" hx-trigger="load" hx-swap="innerHTML"></select>
          </div>
          <div class="row"><label for="note">Note</label><textarea id="note" rows="4"
              placeholder="short, concrete update"></textarea></div>
          <div class="row"><label>&nbsp;</label><small id="noteHint" class="help">A note may be required for some
              codes.</small></div>
          <!-- AI assist panel (suggested code + results) -->
          <div class="row">
            <label>AI Assist</label>
            <div id="assistPanel">
              <div id="assistSuggest" class="help">No suggestion yet.</div>
              <div id="assistResult" style="margin-top:8px;"></div>
            </div>
          </div>

        </div>
        <div class="modal-foot">
          <button id="draftChaseBtn" class="secondary" onclick="devAssistFromModal('chase')" disabled>Draft
            Chase</button>
          <button id="whatsNextBtn" class="secondary" onclick="devAssistFromModal('next')" disabled>What’s
            Next?</button>

          <button class="secondary" onclick="closeSPModal()">Cancel</button>
          <button id="submitBtn" onclick="submitProgress()">Submit</button>
          <span id="submitStatus" class="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      // ES5-compatible script (no arrow fns, no optional chaining, no template strings)
      var API = "";
      var tokenKey = "pocToken";
      // Global lock flag for today
      window.__lockedToday = false;
      // Track if any progress updates have been submitted today
      window.__progressCount = 0;
      // Server-calculated date (YYYY-MM-DD) for today
      window.__serverToday = '';
      // Current user email (set after login)
      window.__meEmail = '';
      // PM-only AI risk rationale
      window.__aiRiskEnabled = false;
      window.__aiRiskMap = null;

      function checkLockStatus() {
        var tkn = localStorage.getItem('pocToken') || '';
        if (!tkn) return Promise.resolve(false);
        return fetch((API || location.origin) + '/api/updates/lock', {
          headers: { 'Authorization': 'Bearer ' + tkn }
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            window.__lockedToday = !!(js && js.locked);
            window.__progressCount = js.progressCount || 0;
            if (js && js.date) window.__serverToday = String(js.date).slice(0, 10);
            // Hide the Submit section and disable select buttons when locked
            var sc = byId('submitCard');
            if (sc) sc.classList.toggle('hidden', window.__lockedToday);
            if (window.__lockedToday) setSelectButtonsDisabled(true);
            // Update lock button state based on progress count
            updateLockButtonState();
            return window.__lockedToday;
          })
          .catch(function () { return false; });
      }

      function updateLockButtonState() {
        var lockButtons = document.querySelectorAll('button[onclick="lockDay()"]');
        lockButtons.forEach(function (btn) {
          // Disable if no progress updates submitted
          btn.disabled = (window.__progressCount === 0);
          if (window.__progressCount === 0) {
            btn.title = 'Submit at least one ticket progress update before completing';
          } else {
            btn.title = '';
          }
        });
      }

      function byId(id) { return document.getElementById(id); }

      function setStatus(id, msg, ok) {
        if (ok === void 0) ok = true;
        var el = byId(id);
        if (!el) return;
        el.classList.remove('ok');   // remove old state
        el.classList.remove('err');
        el.classList.add('status');
        el.classList.add(ok ? 'ok' : 'err');
        el.textContent = msg || '';
      }


      function setSnapBusy(on, label) {
        var btns = Array.prototype.slice.call(
          document.querySelectorAll('button[onclick^="openSnapshots"]')
        );
        btns.forEach(function (b) {
          if (on) {
            if (!b.dataset.old) b.dataset.old = b.textContent;
            b.disabled = true;
            b.textContent = label || 'Opening…';
          } else {
            b.disabled = false;
            if (b.dataset.old) { b.textContent = b.dataset.old; delete b.dataset.old; }
          }
        });
      }



      function token() { return localStorage.getItem(tokenKey) || ""; }

      function esc(s) {
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        s = (s == null) ? "" : String(s);
        return s.replace(/[&<>"']/g, function (c) { return map[c]; });
      }

      function riskBadgeHtml(level, reasons) {
        var l = String(level || 'low').toLowerCase();
        if (l !== 'high' && l !== 'medium' && l !== 'low') l = 'low';
        var label = l.charAt(0).toUpperCase() + l.slice(1);
        var title = '';
        if (reasons) {
          if (Array.isArray(reasons)) title = reasons.join('; ');
          else title = String(reasons);
        }
        return '<span class="badge risk-' + l + '"' + (title ? (' title="' + esc(title) + '"') : '') + '>' + label + '</span>';
      }

      // --- report inputs persistence ---
      function saveReportInputs() {
        try {
          var f = (byId('repFrom') && byId('repFrom').value) || '';
          var t = (byId('repTo') && byId('repTo').value) || '';
          var d = (byId('snapDev') && byId('snapDev').value) || 'all';
          localStorage.setItem('pocRepFrom', f);
          localStorage.setItem('pocRepTo', t);
          localStorage.setItem('pocSnapDev', d);
        } catch (_) { }
      }
      function restoreReportInputs() {
        try {
          var f = localStorage.getItem('pocRepFrom');
          var t = localStorage.getItem('pocRepTo');
          if (f && byId('repFrom')) byId('repFrom').value = f;
          if (t && byId('repTo')) byId('repTo').value = t;
          // snapDev is restored after options load in ensureSnapshotDevDropdown()
        } catch (_) { }
      }
      function reloadSnapshotDevList() {
        var sel = document.getElementById('snapDev');
        if (!sel) return;
        sel.removeAttribute('data-loaded');   // force reload
        // keep the first "all" option; clear the rest
        while (sel.options.length > 1) sel.remove(1);
        ensureSnapshotDevDropdown();
      }

      function updateEmailBtnDisabled() {
        var sel = document.getElementById('snapDev');
        var btn = document.querySelector('button[onclick="emailSnapshots()"]');
        if (!sel || !btn) return;
        var v = (sel.value || '').trim().toLowerCase();
        btn.disabled = !v || v === 'all';
      }
      // call once after dropdown is filled and on change:
      document.addEventListener('DOMContentLoaded', updateEmailBtnDisabled);
      (function () { var _sd = document.getElementById('snapDev'); if (_sd) _sd.addEventListener('change', updateEmailBtnDisabled); })();



      async function emailSnapshots() {
        var devSel = document.getElementById('snapDev');
        var fEl = document.getElementById('repFrom');
        var tEl = document.getElementById('repTo');
        var btn = document.querySelector('button[onclick="emailSnapshots()"]');

        if (!devSel || !devSel.value || devSel.value === 'all') {
          alert('Pick a specific developer first.');
          return;
        }

        var developer = String(devSel.value || '').trim();               // alias OR whatever your value is
        var developerLabel = (function () {
          if (!devSel || !devSel.options || devSel.selectedIndex < 0) return '';
          var opt = devSel.options[devSel.selectedIndex];
          return String((opt && opt.textContent) || '').trim();
        })();

        var fromDate = (fEl && fEl.value) ? fEl.value : new Date().toISOString().slice(0, 10);
        var toDate = (tEl && tEl.value) ? tEl.value : fromDate;

        var token = localStorage.getItem('pocToken') || '';
        if (!token) { alert('Please log in first.'); return; }

        var oldTxt = btn ? btn.textContent : '';
        if (btn) { btn.disabled = true; btn.textContent = 'Sending…'; }

        try {
          const r = await fetch('/api/reports/snapshots/email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ developer, developerLabel, fromDate, toDate, ai: '1' })
          });
          const js = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error((js && js.error) ? js.error : ('HTTP ' + r.status));

          // collect recipient emails only (no names/aliases)
          function onlyEmail(s) {
            s = String(s || '');
            var m = s.match(/<([^>]+)>/);                       // "Name <a@b.com>"
            if (m) return m[1].trim();
            var m2 = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i); // any a@b
            return m2 ? m2[0] : '';
          }

          var emails = [];
          if (js && Array.isArray(js.accepted) && js.accepted.length) {
            emails = js.accepted.slice();
          } else if (js && js.envelope && Array.isArray(js.envelope.to)) {
            emails = js.envelope.to.slice();
          } else if (js && (js.to || js.cc)) {
            var raw = [];
            if (Array.isArray(js.to)) raw = raw.concat(js.to);
            else if (js.to) raw.push(js.to);
            if (Array.isArray(js.cc)) raw = raw.concat(js.cc);
            else if (js.cc) raw.push(js.cc);
            emails = raw.map(onlyEmail).filter(Boolean);
          }

          // fallback: selected option value (should be an email when available)
          if (!emails.length) {
            var opt = devSel && devSel.options && devSel.options[devSel.selectedIndex];
            var v = (opt && opt.value) ? opt.value : developer;
            var e = onlyEmail(v) || v;
            emails = [e];
          }

          // dedupe + show
          var seen = {};
          emails = emails.filter(function (e) { if (seen[e]) return false; seen[e] = true; return true; });

          alert('Email sent to: ' + emails.join(', '));


        } catch (e) {
          alert('Send failed: ' + ((e && e.message) ? e.message : e));
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = oldTxt; }
        }
      }


      function requiresNote(code) {
        var sel = document.getElementById('code');
        if (!sel) return false;
        var opt = sel.querySelector('option[value="' + code + '"]');
        return !!(opt && opt.getAttribute('data-requirenote') === 'true');
      }

      function clearForNewSession() {
        var ids = ['loginStatus', 'loadStatus', 'submitStatus', 'lockStatus', 'exportStatus', 'weeklySummaryStatus'];
        for (var i = 0; i < ids.length; i++) { var el = byId(ids[i]); if (el) el.textContent = ''; }
        var le = byId('loginEmail'); if (le) le.value = '';
        var lp = byId('loginPw'); if (lp) lp.value = '';
        var tId = byId('tId'); if (tId) tId.value = '';
        var codeSel = byId('code'); if (codeSel) codeSel.selectedIndex = 0;
        var note = byId('note'); if (note) note.value = '';
        var assigned = byId('assigned'); if (assigned) assigned.value = '';
        var q = byId('q'); if (q) q.value = '';
        var filters = byId('findFilters'); if (filters) filters.style.display = '';
        var tbody = document.querySelector('#ticketsTbl tbody'); if (tbody) tbody.innerHTML = '';
        var sec = ['today', 'blockers', 'missing'];
        for (var j = 0; j < sec.length; j++) { var el2 = byId(sec[j]); if (el2) el2.innerHTML = ''; }
        var ws = byId('weeklySummaryBody'); if (ws) ws.innerHTML = 'Log in to see your last 7 days of progress.';
        setSelectButtonsDisabled(false);
        window.__serverToday = '';
      }

      function setSelectButtonsDisabled(on) {
        var btns = document.querySelectorAll('#ticketsTbl tbody button');
        for (var i = 0; i < btns.length; i++) btns[i].disabled = !!on;
      }

      function setMe(email, name) {
        window.__meEmail = email || '';
        var assigned = byId("assigned");
        if (assigned && !assigned.value && email) {
          assigned.value = String(email).split("@")[0];
        }
        var me = byId("me");
        me.textContent = email ? (name || email) : "";
        var btn = byId("logoutBtn");
        if (btn) btn.classList.toggle("hidden", !email);

        if (!email) {
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        }
      }

      function setRoleUI(role) {
        var isPM = (role === 'pm');
        window.__role = role;
        var loginCard = byId('loginCard');
        var ticketsCard = byId('ticketsCard');
        var submitCard = byId('submitCard');
        var pmBox = byId('pm');
        var weeklyCard = byId('weeklySummaryCard');

        if (loginCard) loginCard.classList.add('hidden');
        if (ticketsCard) ticketsCard.classList.remove('hidden');
        if (submitCard) submitCard.classList.toggle('hidden', isPM); // hide for PMs
        if (weeklyCard) weeklyCard.classList.toggle('hidden', isPM);
        if (!isPM) {
          var p = checkLockStatus();
          if (p && typeof p.then === 'function') p.then(function () { loadWeeklySummary(); });
          else loadWeeklySummary();
        }

        if (pmBox) pmBox.classList.toggle('hidden', !isPM);

        if (pmBox) {
          var controls = pmBox.querySelectorAll('button, a');
          for (var i = 0; i < controls.length; i++) {
            if (!isPM) controls[i].setAttribute('disabled', 'disabled');
            else controls[i].removeAttribute('disabled');
          }
        }

        var me = byId("me");
        if (me) {
          var txt = me.textContent;
          me.innerHTML = esc(txt);
          var badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = isPM ? 'PM' : 'DEV';
          me.appendChild(document.createTextNode(' '));
          me.appendChild(badge);
        }

        var filters = byId('findFilters');
        if (isPM) {
          ensureAssignedDropdownForPM();
          ensureSnapshotDevDropdown();

          if (filters) filters.style.display = '';
          loadToday(); loadBlockers(); loadMissing();

          presetReportThisWeek(false);
          if (!window.__exportTimer) {
            window.__exportTimer = setInterval(function () {
              var pmEl = byId('pm');
              if (pmEl && !pmEl.classList.contains('hidden')) { }
            }, 60000);
          }
        } else {
          if (filters) filters.style.display = 'none';
          loadTickets();
        }
      }

      function syncNoteRequirement() {
        var code = byId('code').value;
        var note = byId('note');
        var hint = byId('noteHint');
        var need = requiresNote(code);
        note.required = !!need;
        hint.style.fontWeight = need ? '600' : '400';
        hint.style.opacity = need ? '1' : '.7';

        // NEW: toggle AI buttons availability based on selected code
        updateAssistAvailability();
      }


      function req(method, url, body, headers) {
        var opts = { method: method, headers: headers || {} };
        if (body != null) opts.body = body;
        return fetch(url, opts).then(function (res) { return res.json(); });
      }

      function signup() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Signing up...");
        req('POST', (API || location.origin) + "/api/auth/signup", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) { if (js.error) setStatus("loginStatus", js.error, false); else setStatus("loginStatus", "Account created. Please login."); })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function login() {
        var email = byId("loginEmail").value.trim();
        var pw = byId("loginPw").value;
        setStatus("loginStatus", "Logging in...");
        req('POST', (API || location.origin) + "/api/auth/login", JSON.stringify({ email: email, password: pw }), { "Content-Type": "application/json" })
          .then(function (js) {
            if (js.error) { setStatus("loginStatus", js.error, false); return; }
            clearForNewSession();
            localStorage.setItem(tokenKey, js.token);
            setMe(js.email, js.name);
            setRoleUI(js.role || 'dev');
            refreshIterationBadge();
            setStatus("loginStatus", "Logged in.");
          })
          .catch(function () { setStatus("loginStatus", "Network error", false); });
      }

      function logout(all) {
        if (all === void 0) all = false;
        var t = localStorage.getItem("pocToken");
        var done = function () {
          localStorage.removeItem("pocToken");
          clearForNewSession();
          setMe("", "");
          setStatus("loginStatus", "Logged out.");
          var lb = byId("logoutBtn"); if (lb) lb.classList.add("hidden");
          var lc = byId('loginCard'); if (lc) lc.classList.remove('hidden');
          var tc = byId('ticketsCard'); if (tc) tc.classList.add('hidden');
          var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
          var pm = byId('pm'); if (pm) pm.classList.add('hidden');
        };
        if (t) {
          req('POST', (API || location.origin) + (all ? "/api/auth/logout_all" : "/api/auth/logout"), null, { "Authorization": "Bearer " + t }).then(function () { done(); }).catch(function () { done(); });
        } else { done(); }
      }


      // --- Shared team-members dropdown helpers -----------------------------------
      var __teamMembersCache = null;

      function getTeamMembers() {
        if (__teamMembersCache) return Promise.resolve(__teamMembersCache);
        var tkn = localStorage.getItem('pocToken') || '';
        return fetch((API || location.origin) + '/api/team-members', {
          headers: { 'Authorization': 'Bearer ' + tkn }
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var items = (js && js.items) || [];
            __teamMembersCache = items;
            return items;
          })
          .catch(function () { return []; });
      }

      /**
       * populateTeamSelect(selectEl, cfg)
       * cfg:
       *  - keepFirst: keep the first existing <option> (e.g., “All”) and clear the rest
       *  - includeBlank: insert a blank-all option at top
       *  - blankLabel: label for blank option
       *  - restoreKey: localStorage key whose value should be restored as .value
       *  - setDataEmail: set data-email attribute when member has email
       *  - getValue(member): returns value string for <option>
       *  - getLabel(member): returns label string for <option> (defaults to display_name/alias/email)
       *  - onAfter(selectEl): callback after population (e.g., toggle buttons)
       */
      function populateTeamSelect(sel, cfg) {
        cfg = cfg || {};
        if (!sel) return Promise.resolve();

        // Clear options
        if (cfg.keepFirst) {
          while (sel.options.length > 1) sel.remove(1);
        } else {
          sel.innerHTML = '';
        }

        if (cfg.includeBlank) {
          var blank = document.createElement('option');
          blank.value = '';
          blank.textContent = cfg.blankLabel || '— All —';
          sel.appendChild(blank);
        }

        var saved = cfg.restoreKey ? (localStorage.getItem(cfg.restoreKey) || '') : '';

        return getTeamMembers().then(function (items) {
          for (var i = 0; i < items.length; i++) {
            var m = items[i];
            var opt = document.createElement('option');

            var val = cfg.getValue
              ? cfg.getValue(m)
              : ((m.email && m.email.trim()) ? m.email.toLowerCase() : (m.alias || '').toLowerCase());
            opt.value = String(val || '').trim();

            if (cfg.setDataEmail && m.email) opt.setAttribute('data-email', m.email.toLowerCase());

            var label = cfg.getLabel
              ? cfg.getLabel(m)
              : (m.display_name || m.alias || m.email || '').trim();

            // If the fallback is an email, show only the username part (before @)
            if (/@/.test(label)) {
              label = label.split('@')[0];
            }

            // Show ONLY the clean label — no alias/email appended
            opt.textContent = label;

            // (optional) keep details in data-* for internal use
            if (m.alias) opt.dataset.alias = String(m.alias).toLowerCase();
            if (m.email) opt.dataset.email = String(m.email).toLowerCase();


            sel.appendChild(opt);
          }

          // Restore previously saved value if any
          if (saved) {
            var want = saved.toLowerCase();
            var ok = Array.prototype.some.call(sel.options, function (o) {
              return (String(o.value || '').toLowerCase() === want);
            });
            if (ok) sel.value = saved;
          }

          sel.setAttribute('data-loaded', '1');
          if (typeof cfg.onAfter === 'function') cfg.onAfter(sel);
        });
      }

      function ensureAssignedDropdownForPM() {
        var isPM = (window.__role === 'pm');
        if (!isPM) return;

        var original = byId('assigned');
        if (!original) return;
        if (original.tagName && original.tagName.toLowerCase() === 'select') return;

        // Turn the existing input into a <select>
        var sel = document.createElement('select');
        sel.id = 'assigned';
        sel.setAttribute('aria-label', 'Assigned to');
        sel.style.minWidth = '220px';
        original.parentNode.replaceChild(sel, original);

        // Populate using shared function (value = alias; attach data-email)
        populateTeamSelect(sel, {
          includeBlank: true,
          blankLabel: '— All / Anyone —',
          setDataEmail: true,
          getValue: function (m) { return (m.alias || '').trim(); },
          getLabel: function (m) { return (m.display_name || m.alias || m.email || '').trim(); }
        }).then(function () {
          sel.addEventListener('change', function () {
            var loadBtn = byId('loadBtn');
            if (loadBtn) loadBtn.click();
          });
        });
      }

      function ensureSnapshotDevDropdown() {
        var sel = document.getElementById('snapDev');
        if (!sel) return;

        if (sel.getAttribute('data-loaded') === '1') {
          var want = (localStorage.getItem('pocSnapDev') || '').toLowerCase();
          if (want && sel.value.toLowerCase() !== want) sel.value = want;
          updateEmailBtnDisabled();
          return;
        }

        populateTeamSelect(sel, {
          keepFirst: true,
          restoreKey: 'pocSnapDev',
          setDataEmail: true,
          getValue: function (m) {
            return (m.email && m.email.trim())
              ? m.email.toLowerCase()
              : (m.alias || '').toLowerCase();
          },
          getLabel: function (m) { return (m.display_name || m.alias || m.email || '').trim(); },
          onAfter: function (selectEl) {
            updateEmailBtnDisabled();
            selectEl.addEventListener('change', saveReportInputs);
          }
        });

      }








      function openSnapshots(fmt) {
        var fEl = document.getElementById('repFrom');
        var tEl = document.getElementById('repTo');
        var dEl = document.getElementById('snapDev');

        var f = (fEl && fEl.value) ? fEl.value : new Date().toISOString().slice(0, 10);
        var t = (tEl && tEl.value) ? tEl.value : f;
        var dev = (dEl && typeof dEl.value === 'string') ? dEl.value.trim().toLowerCase() : 'all';
        if (!dev) dev = 'all';

        try {
          localStorage.setItem('pocRepFrom', f);
          localStorage.setItem('pocRepTo', t);
          localStorage.setItem('pocSnapDev', dev);
        } catch (_) { }

        var url = (window.API || location.origin) + '/api/reports/snapshots'
          + '?from=' + encodeURIComponent(f)
          + '&to=' + encodeURIComponent(t)
          + '&developer=' + encodeURIComponent(dev)
          + '&ai=1';

        var tkn = localStorage.getItem('pocToken') || '';
        var wantHtml = (fmt || 'pdf') === 'html';

        var headers = {
          'Accept': wantHtml ? 'text/html' : 'application/pdf'
        };
        if (tkn) headers['Authorization'] = 'Bearer ' + tkn;

        setSnapBusy(true, 'Opening…');

        fetch(url + (wantHtml ? '&format=html' : '&format=pdf'), {
          headers: headers,
          redirect: 'follow'
        })
          .then(async function (r) {
            // Handle HTTP errors first
            if (!r.ok) {
              var body = await r.text().catch(function () { return ''; });
              throw new Error('HTTP ' + r.status + (body ? (' — ' + body.slice(0, 200)) : ''));
            }

            // Redirects that land on HTML (login pages, etc.)
            if (r.redirected) {
              // Even if 200, this usually means we followed to HTML, not a PDF
              var ct = (r.headers.get('content-type') || '').toLowerCase();
              if (!wantHtml && ct.indexOf('application/pdf') === -1) {
                var s = await r.text().catch(function () { return ''; });
                throw new Error('Request redirected (likely to a login page). ' + (s ? s.slice(0, 200) : ''));
              }
            }

            if (wantHtml) return r.text();

            // When we expect a PDF:
            var ct = (r.headers.get('content-type') || '').toLowerCase();

            // If server wraps the PDF as JSON base64
            if (ct.indexOf('application/json') > -1) {
              var js = await r.json();
              var b64 = js && (js.pdf_base64 || js.pdf || js.data);
              if (!b64) throw new Error('Expected PDF but got JSON without a base64 field.');
              var bin = atob(String(b64));
              var bytes = new Uint8Array(bin.length);
              for (var i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
              return new Blob([bytes], { type: 'application/pdf' });
            }

            // Must be a real PDF; otherwise surface the HTML/text so you can see the error
            if (ct.indexOf('application/pdf') === -1) {
              var msg = await r.text().catch(function () { return ''; });
              throw new Error('Expected a PDF but received ' + (ct || 'unknown type') + (msg ? (' — ' + msg.slice(0, 200)) : ''));
            }

            return r.blob();
          })
          .then(function (payload) {
            if (wantHtml) {
              var w = window.open('about:blank', '_blank');
              if (!w) return alert('Popup blocked. Allow popups for this site.');
              w.document.open(); w.document.write(payload); w.document.close();
            } else {
              var href = URL.createObjectURL(payload);
              var a = document.createElement('a');
              a.href = href;
              a.download = 'Developer-Snapshots_' + f + '_to_' + t + '.pdf';
              document.body.appendChild(a); a.click(); a.remove();
              setTimeout(function () { URL.revokeObjectURL(href); }, 1200);
            }
          })
          .catch(function (err) {
            alert('Failed to open snapshots: ' + (err && err.message ? err.message : err));
          })
          .finally(function () { setSnapBusy(false); });
      }

      async function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result); // "data:application/pdf;base64,...."
          fr.onerror = reject;
          fr.readAsDataURL(blob);
        });
      }


      function loadTickets() {
        var assigned = byId("assigned");
        var q = byId("q");
        var btn = byId("loadBtn");
        var status = byId("loadStatus");
        status.textContent = "Loading...";
        btn.disabled = true;

        var tbody = document.querySelector("#ticketsTbl tbody");
        tbody.innerHTML = "";
        for (var i = 0; i < 5; i++) {
          var tr = document.createElement('tr'); tr.className = 'skeleton';
          tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
          tbody.appendChild(tr);
        }
        var url = new URL((API || location.origin) + "/api/tickets");
        if (assigned && assigned.value.trim()) {
          url.searchParams.set("assignedTo", assigned.value.trim());
          if (window.__role === 'pm') {
            var opt = assigned.options[assigned.selectedIndex];
            var em = opt && opt.getAttribute('data-email');
            var by = (em || assigned.value.trim());
            if (by) url.searchParams.set('updatesBy', by);
            // PM users should see all work item types (including Tasks)
            url.searchParams.set('types', 'all');
            url.searchParams.set('typesOverride', '1');
          }
        }

        var hdrs = {};
        var tkn = localStorage.getItem("pocToken");
        if (tkn) hdrs["Authorization"] = "Bearer " + tkn;

        fetch(url, { headers: hdrs })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            status.textContent = "Loaded " + (js.count || 0) + " ticket(s)";
            tbody.innerHTML = "";
            var items = js.items || [];
            for (var k = 0; k < items.length; k++) {
              var t = items[k];
              var tr2 = document.createElement("tr");
              tr2.setAttribute("data-id", String(t.id));
              var code = t.lastCode || t.progressCode || t.code || '';
              var note = t.lastNote || t.progressNote || t.note || '';
              var typ = t.type || t.workItemType || t.itemType || t.kind || '';
              // Keep a simple cache by ID so dev-assist can read tags if present
              window.__lastTickets = window.__lastTickets || {};
              window.__lastTickets[String(t.id)] = t;

              tr2.innerHTML =
                '<td>' + esc(t.id) + '</td>' +
                '<td>' + esc(typ || '—') + '</td>' +
                '<td><i>' + esc(t.title) + '</i></td>' +
                '<td>' + esc(t.state) + '</td>' +
                '<td>' + esc(t.severity || '—') + '</td>' +
                '<td>' + esc(code || '—') + '</td>' +
                '<td>' + esc(note || '—') + '</td>' +
                '<td>' + (
                  (window.__role !== 'dev' || window.__lockedToday)
                    ? ''
                    : (
                      '<div class="toolbar" role="group">'

                      + '<button class="secondary" onclick="openSPModal(' + Number(t.id) + ')" aria-label="Select ticket ' + esc(t.id) + '">Select</button>'
                      + '</div>'
                    )
                ) + '</td>';







              tbody.appendChild(tr2);
              var cells = tr2.getElementsByTagName('td');
              renderCodeBadge(cells[5], code);
            }
          })
          .catch(function () {
            status.textContent = "Failed to load";
            status.classList.add('err');
            tbody.innerHTML = '<tr><td colspan="8">Unable to load tickets. Check network or try again.</td></tr>';
          })
          .finally(function () { btn.disabled = false; });
      }

      function loadWeeklySummary() {
        var body = byId('weeklySummaryBody');
        var st = byId('weeklySummaryStatus');
        if (!body) return;

        var tkn = token();
        if (!tkn) {
          body.innerHTML = 'Log in to see your last 7 days of progress.';
          if (st) { st.textContent = ''; st.classList.remove('ok', 'err'); }
          return;
        }

        if (st) { st.textContent = 'Loading...'; st.classList.remove('ok', 'err'); }
        body.innerHTML = '<div class="help">Loading summary...</div>';

        var todayStr = window.__serverToday || ymd(new Date());
        var fromStr = addDays(todayStr, -6);
        var assigned = byId('assigned');
        var assignedVal = (assigned && assigned.value) ? assigned.value.trim() : '';
        var dev = window.__meEmail || assignedVal;

        var hdrs = { 'Authorization': 'Bearer ' + tkn };

        var url = new URL((API || location.origin) + "/api/updates/range");
        url.searchParams.set('from', fromStr);
        url.searchParams.set('to', todayStr);
        if (dev) url.searchParams.set('developer', dev);

        var lockUrl = new URL((API || location.origin) + "/api/updates/locks/range");
        lockUrl.searchParams.set('from', fromStr);
        lockUrl.searchParams.set('to', todayStr);

        var updatesPromise = fetch(url, { headers: hdrs })
          .then(function (r) { return r.json(); });
        var locksPromise = fetch(lockUrl, { headers: hdrs })
          .then(function (r) { return r.json(); })
          .catch(function () { return null; });

        Promise.all([updatesPromise, locksPromise])
          .then(function (res) {
            var js = res[0] || {};
            var locks = res[1];
            if (js && js.error) throw new Error(js.error);
            var items = js.items || [];

            var dayCounts = {};
            var days = [];
            for (var i = 0; i < 7; i++) {
              var d = addDays(fromStr, i);
              days.push(d);
              dayCounts[d] = 0;
            }

            var tickets = {};
            var codeMix = {};
            var blockers = 0;
            for (var k = 0; k < items.length; k++) {
              var it = items[k] || {};
              var d2 = String(it.date || '').slice(0, 10);
              if (d2) {
                if (dayCounts.hasOwnProperty(d2)) dayCounts[d2] += 1;
                else dayCounts[d2] = 1;
              }
              if (it.ticketId != null) tickets[String(it.ticketId)] = true;
              var code = it.code ? String(it.code) : '';
              if (code) {
                var fam = code.slice(0, 3);
                codeMix[fam] = (codeMix[fam] || 0) + 1;
                if (/^(600|700|800)_/.test(code)) blockers += 1;
              }
            }

            var updatesCount = items.length;
            var ticketCount = Object.keys(tickets).length;
            var activeDays = 0;
            for (var dk in dayCounts) {
              if (dayCounts.hasOwnProperty(dk) && dayCounts[dk] > 0) activeDays += 1;
            }

            var lockCount = null;
            if (locks && !locks.error && locks.count != null) {
              var lc = Number(locks.count);
              lockCount = isNaN(lc) ? null : lc;
            }

            var families = [];
            for (var f in codeMix) {
              if (codeMix.hasOwnProperty(f)) {
                families.push({ fam: f, count: codeMix[f] });
              }
            }
            families.sort(function (a, b) {
              return (b.count - a.count) || String(a.fam).localeCompare(String(b.fam));
            });

            var html = '';
            html += '<div class="help">Range: ' + esc(fromStr) + ' to ' + esc(todayStr) + '</div>';
            html += '<div class="toolbar" style="margin-top:6px;">';
            html += '<span class="badge">Updates: ' + updatesCount + '</span>';
            html += '<span class="badge">Tickets: ' + ticketCount + '</span>';
            html += '<span class="badge">Active days: ' + activeDays + '/7</span>';
            html += '<span class="badge">Blocker updates: ' + blockers + '</span>';
            html += '<span class="badge">Locked days: ' + (lockCount == null ? '-' : (lockCount + '/7')) + '</span>';
            html += '</div>';

            html += '<div class="help" style="margin-top:8px;">Daily updates</div>';
            html += '<div class="toolbar">';
            for (var di = 0; di < days.length; di++) {
              var dd = days[di];
              var label = dd.slice(5);
              html += '<span class="badge">' + esc(label) + ': ' + (dayCounts[dd] || 0) + '</span>';
            }
            html += '</div>';

            html += '<div class="help" style="margin-top:8px;">Code mix</div>';
            if (families.length) {
              html += '<div class="toolbar">';
              for (var fi = 0; fi < families.length && fi < 6; fi++) {
                var famLabel = families[fi].fam ? (families[fi].fam + '_xx') : '—';
                html += '<span class="badge">' + esc(famLabel) + ' · ' + families[fi].count + '</span>';
              }
              html += '</div>';
            } else {
              html += '<div class="help">No codes recorded yet.</div>';
            }

            body.innerHTML = html;
            setStatus('weeklySummaryStatus', updatesCount + ' update(s)');
          })
          .catch(function () {
            body.innerHTML = '<div class="help">Unable to load weekly summary.</div>';
            setStatus('weeklySummaryStatus', 'Failed to load', false);
          });
      }

      function openSPModal(id) {
        if (window.__role === 'pm') return;
        if (window.__lockedToday) {
          setStatus('submitStatus', 'Day is locked. Ask a PM to unlock to change updates.', false);
          return;
        }
        var m = byId('spModal'), b = byId('spBackdrop');
        if (id != null) byId('tId').value = String(id);

        if (window.syncNoteRequirement) syncNoteRequirement();

        // now only resets panel + wires listeners; no network yet
        prepareDevAssistUI(String(id || byId('tId').value || ''));

        m.classList.add('open'); b.classList.add('open');
        setTimeout(function () { var t = byId('tId'); if (t) t.focus(); }, 0);
      }



      function closeSPModal() {
        var m = byId('spModal'), b = byId('spBackdrop');
        m.classList.remove('open'); b.classList.remove('open');
      }

      // --- AI Assist (modal) ------------------------------------------------------
      var __assistTicketId = null;
      var __assistDebounceTimer = 0;

      function prepareDevAssistUI(ticketId) {
        __assistTicketId = String(ticketId || '');
        var sug = byId('assistSuggest'); if (sug) sug.textContent = 'Select a code and add a note to see suggestions.';
        var res = byId('assistResult'); if (res) res.innerHTML = '';
        var chaseBtn = byId('draftChaseBtn'); if (chaseBtn) chaseBtn.disabled = true;
        var nextBtn = byId('whatsNextBtn'); if (nextBtn) nextBtn.disabled = true;

        // (re)wire listeners so we can trigger suggestions when both fields are ready
        var sel = byId('code');
        var note = byId('note');
        if (sel) sel.onchange = function () {
          if (typeof syncNoteRequirement === 'function') syncNoteRequirement();
          maybeSuggestForModal();
        };
        if (note) {
          note.oninput = function () { maybeSuggestForModal(); };
          note.onchange = function () { maybeSuggestForModal(); };
        }
      }

      // Debounced trigger
      function maybeSuggestForModal() {
        clearTimeout(__assistDebounceTimer);
        __assistDebounceTimer = setTimeout(runSuggestIfReady, 300);
      }

      function runSuggestIfReady() {
        var sug = byId('assistSuggest');
        var sel = byId('code');
        var note = byId('note');

        var code = sel && sel.value ? sel.value.trim() : '';
        var txt = note && note.value ? note.value.trim() : '';

        // enable/disable assist buttons strictly based on code (you already call updateAssistAvailability inside syncNoteRequirement)
        if (typeof updateAssistAvailability === 'function') updateAssistAvailability();

        if (!code || !txt) {
          if (sug) sug.textContent = 'Select a code and add a note to see suggestions.';
          return;
        }

        // we have both → call triage once for suggest_code
        if (sug) sug.textContent = 'Thinking…';

        var t = (window.__lastTickets || {})[String(__assistTicketId)] || null;
        if (!t) { if (sug) sug.textContent = 'No local context available.'; return; }

        var item = {
          ticketId: t.id,
          title: t.title || '',
          state: t.state || '',
          type: t.type || '',
          assignedTo: t.assignedTo || '',
          iterationPath: t.iterationPath || '',
          tags: t.tags || '',
          code: code,      // current selection
          note: txt        // user note
        };

        fetch((window.API || location.origin) + '/api/ai/triage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('pocToken') || '')
          },
          body: JSON.stringify({ items: [item] })
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var s = js && js.suggestions && js.suggestions[0];
            if (!s) { if (sug) sug.textContent = 'No suggestion.'; return; }

            var sc = s.suggest_code || '';
            if (sc && byId('assistSuggest')) {
              byId('assistSuggest').innerHTML =
                '<span class="badge">Suggested code: ' + esc(sc) + '</span> ' +
                '<button class="secondary" onclick="applySuggestedCodeToModal(\'' +
                esc(sc).replace(/'/g, "\\'") + '\')">Apply</button>';
            } else {
              if (sug) sug.textContent = 'No code suggestion.';
            }
          })
          .catch(function () {
            if (sug) sug.textContent = 'AI suggest failed.';
          });
      }


      function applySuggestedCodeToModal(code) {
        var sel = byId('code');
        if (!sel) return;
        sel.value = String(code || '');
        if (typeof syncNoteRequirement === 'function') syncNoteRequirement();
      }


      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') { closeSPModal(); }
      });

      function prefill(id) {
        byId("tId").value = id;
        byId('submitCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function submitProgress() {
        var tkn = token();
        if (!tkn) { setStatus("submitStatus", "Please login first.", false); return; }
        if (window.__lockedToday) { setStatus("submitStatus", "Update is locked. Ask a PM to unlock.", false); return; }

        var ticket = byId("tId").value.trim();
        var code = byId("code").value;
        var note = byId("note").value.trim();
        if (!ticket) { setStatus("submitStatus", "Ticket ID is required.", false); return; }
        if (requiresNote(code) && !note) { setStatus("submitStatus", "A note is required for this code.", false); return; }
        setStatus("submitStatus", "Submitting...");
        var btn = byId('submitBtn'); btn.disabled = true;
        req('POST', (API || location.origin) + "/api/progress", JSON.stringify({ ticketId: ticket, code: code, note: note }), { "Content-Type": "application/json", "Authorization": "Bearer " + tkn })
          .then(function (js) {
            if (js && js.error) setStatus("submitStatus", js.error, false); else {
              setStatus("submitStatus", "Saved!");
              // Increment progress count and update lock button state
              window.__progressCount = (window.__progressCount || 0) + 1;
              updateLockButtonState();
              byId("note").value = "";
              closeSPModal();
              var row = document.querySelector('#ticketsTbl tbody tr[data-id="' + ticket + '"]');
              if (row) {
                var cells = row.getElementsByTagName('td');
                if (cells[5]) renderCodeBadge(cells[5], code || '');
                if (cells[6]) cells[6].textContent = note || '—';
              } else {
                if (typeof loadTickets === 'function') { loadTickets(); }
              }
            }
          })
          .catch(function () { setStatus("submitStatus", "Network error", false); })
          .finally(function () { btn.disabled = false; });
      }

      function runPreLockCheck() {
        var assigned = byId('assigned');
        var assignedVal = (assigned && assigned.value) ? assigned.value.trim() : '';
        if (!assignedVal) return Promise.resolve(null);

        var tkn = token();
        var hdrs = {};
        if (tkn) hdrs["Authorization"] = "Bearer " + tkn;

        var todayStr = window.__serverToday || ymd(new Date());
        var dev = window.__meEmail || assignedVal;

        var ticketsUrl = new URL((API || location.origin) + "/api/tickets");
        ticketsUrl.searchParams.set('assignedTo', assignedVal);

        var updatesUrl = new URL((API || location.origin) + "/api/updates/range");
        updatesUrl.searchParams.set('from', todayStr);
        updatesUrl.searchParams.set('to', todayStr);
        if (dev) updatesUrl.searchParams.set('developer', dev);

        var ticketsPromise = fetch(ticketsUrl, { headers: hdrs })
          .then(function (r) { return r.json(); });
        var updatesPromise = fetch(updatesUrl, { headers: hdrs })
          .then(function (r) { return r.json(); });

        return Promise.all([ticketsPromise, updatesPromise])
          .then(function (res) {
            var tjs = res[0] || {};
            var ujs = res[1] || {};
            var items = tjs.items || [];
            var updates = ujs.items || [];

            var assignedIds = {};
            for (var i = 0; i < items.length; i++) {
              var it = items[i];
              if (it && it.id != null) assignedIds[String(it.id)] = true;
            }

            var updatedIds = {};
            for (var j = 0; j < updates.length; j++) {
              var u = updates[j];
              if (u && u.ticketId != null) updatedIds[String(u.ticketId)] = true;
            }

            var missing = [];
            for (var id in assignedIds) {
              if (assignedIds.hasOwnProperty(id) && !updatedIds[id]) {
                missing.push(id);
              }
            }

            return {
              missing: missing,
              assignedCount: Object.keys(assignedIds).length,
              updatedCount: Object.keys(updatedIds).length
            };
          })
          .catch(function () { return null; });
      }

      function lockDay() {
        var tkn = token();
        if (!tkn) { setStatus("lockStatus", "Please login first.", false); return; }

        // Check if any progress updates have been submitted
        if (window.__progressCount === 0) {
          setStatus("lockStatus", "Please submit at least one ticket progress update before completing.", false);
          return;
        }

        function doLockRequest() {
          setStatus("lockStatus", "Submitting day...");
          req('POST', (API || location.origin) + "/api/updates/lock", null, { "Authorization": "Bearer " + tkn })
            .then(function (js) {
              if (js.error) setStatus("lockStatus", js.error, false);
              else setStatus("lockStatus", js.locked ? "Update submitted (locked)" : "Not locked", !!js.locked);
              if (js.locked) {
                window.__lockedToday = true;
                setSelectButtonsDisabled(true);
                var sc = byId('submitCard'); if (sc) sc.classList.add('hidden');
                var badgeEl = byId("me").querySelector('.badge');
                var txt = badgeEl ? badgeEl.textContent : '';
                if (txt === 'PM') { loadToday(); loadBlockers(); loadMissing(); }
                if (typeof loadWeeklySummary === 'function') loadWeeklySummary();
              }
            })
            .catch(function () { setStatus("lockStatus", "Network error", false); });
        }

        setStatus("lockStatus", "Checking for missing updates...");
        runPreLockCheck()
          .then(function (res) {
            if (res && res.missing && res.missing.length) {
              var preview = res.missing.slice(0, 6);
              var msg = 'You have ' + res.missing.length + ' assigned ticket(s) with no update today';
              msg += ': ' + preview.join(', ');
              if (res.missing.length > preview.length) {
                msg += ' (+' + (res.missing.length - preview.length) + ' more)';
              }
              msg += '.\n\nLock the day anyway?';
              if (!confirm(msg)) {
                setStatus("lockStatus", "Lock canceled. Add updates and try again.", false);
                return;
              }
            }
            doLockRequest();
          })
          .catch(function () {
            doLockRequest();
          });
      }

      function initials(s) {
        s = String(s || '').trim();
        if (!s) return "?";
        var parts = s.split(/\s+/);
        var a = (parts[0] || '')[0] || '';
        var b = (parts.length > 1 ? (parts[parts.length - 1] || '')[0] : '') || '';
        return (a + b).toUpperCase();
      }

      function getAiRiskForTicket(id) {
        if (!window.__aiRiskEnabled || !window.__aiRiskMap) return null;
        return window.__aiRiskMap[String(id)] || null;
      }

      function fetchAiRiskForToday() {
        var st = byId('aiRiskStatus');
        if (st) { st.textContent = 'Thinking...'; st.classList.remove('ok', 'err'); }
        var tkn = token();
        return fetch((API || location.origin) + "/api/updates/today/ai", {
          headers: { 'Authorization': 'Bearer ' + tkn }
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (js && js.error) {
              if (st) { st.textContent = js.error; st.classList.add('err'); }
              return null;
            }
            var items = (js && js.items) ? js.items : [];
            var map = {};
            for (var i = 0; i < items.length; i++) {
              var it = items[i];
              if (!it || !it.id) continue;
              map[String(it.id)] = {
                riskLevel: it.risk_level || 'low',
                rationale: it.rationale || ''
              };
            }
            window.__aiRiskMap = map;
            if (st) { st.textContent = 'Ready'; st.classList.add('ok'); }
            return map;
          })
          .catch(function (e) {
            if (st) { st.textContent = (e && e.message) ? e.message : 'AI failed'; st.classList.add('err'); }
            return null;
          });
      }

      function toggleAiRisk() {
        window.__aiRiskEnabled = !window.__aiRiskEnabled;
        var btn = byId('aiRiskToggle');
        if (btn) btn.textContent = window.__aiRiskEnabled ? 'AI Risk: On' : 'AI Risk Rationale';
        if (window.__aiRiskEnabled) {
          fetchAiRiskForToday().then(function () { loadToday(); });
        } else {
          window.__aiRiskMap = null;
          var st = byId('aiRiskStatus');
          if (st) st.textContent = '';
          loadToday();
        }
      }

      function loadToday() {
        var box = document.getElementById("today");
        fetch((window.API || location.origin) + "/api/updates/today")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var out = [];
            out.push('<div class="pre-list">');

            var users = js.users || [];
            for (var u = 0; u < users.length; u++) {
              var user = users[u];
              var display = user.name ? user.name : user.email;
              var meta = user.name ? user.email : '';
              var tickets = user.tickets || [];
              var total = tickets.length;

              out.push('<div class="pre-user">');
              out.push('<div class="pre-head">');
              out.push('<div class="pre-ident">');
              out.push('<span class="avatar">' + initials(display) + '</span>');
              out.push('<div>');
              out.push('<div class="pre-title">' + esc(display) + '</div>');
              if (meta) out.push('<div class="pre-meta">' + esc(meta) + '</div>');
              out.push('</div>');
              out.push('</div>');

              out.push('<span class="pill">');
              out.push('<span class="pre-meta">' + total + ' item(s)</span>');
              out.push('<span class="badge ' + (user.locked ? 'ok' : 'muted') + '">' + (user.locked ? 'Locked' : 'Open') + '</span>');

              // NEW: show per-dev Unlock beside the status for PM role
              if (window.__role === 'pm' && user.locked && user.email) {
                out.push(
                  '<button class="secondary small unlock-btn" ' +
                  'data-email="' + esc(user.email) + '" ' +
                  'onclick="pmUnlockUser(this)">' +
                  'Unlock' +
                  '</button>'
                );
              }

              out.push('</span>');


              out.push('</div>');

              var groups = {};
              for (var t = 0; t < tickets.length; t++) {
                var it = tickets[t];
                var key = (it.assignedTo && String(it.assignedTo).trim()) ? it.assignedTo : "(unassigned)";
                if (!groups[key]) groups[key] = [];
                groups[key].push(it);
              }

              var keys = Object.keys(groups).sort(function (a, b) { return a.localeCompare(b); });
              if (keys.length === 0) {
                out.push('<div class="subgroup">No updates yet today.</div>');
              } else {
                for (var k = 0; k < keys.length; k++) {
                  var gk = keys[k];
                  var arr = groups[gk];

                  out.push('<table class="today-grid"><thead><tr>');
                  out.push('<th style="width:75px">ID</th>');
                  out.push('<th style="width:110px">Type</th>');
                  out.push('<th style="width:350px">Title</th>');
                  out.push('<th style="width:120px">State</th>');
                  out.push('<th style="width:75px">Code</th>');
                  out.push('<th style="width:90px">Risk</th>');
                  out.push('<th>Note</th>');
                  out.push('</tr></thead><tbody>');

                  for (var m = 0; m < arr.length; m++) {
                    var it2 = arr[m];
                    var typ2 = it2.type || it2.workItemType || it2.itemType || it2.kind || '';
                    var fam = (it2.code ? String(it2.code).slice(0, 3) : null);
                    var codeBadge = it2.code
                      ? '<span class="badge code-' + fam + '">' + esc(it2.code) + '</span>'
                      : '-';
                    var riskBadge = riskBadgeHtml(it2.riskLevel, it2.riskReasons);

                    out.push('<tr>');
                    out.push('<td>' + esc(it2.ticketId) + '</td>');
                    out.push('<td>' + esc(typ2 || '-') + '</td>');
                    out.push('<td><i>' + esc(it2.title || '') + '</i></td>');
                    out.push('<td>' + esc(it2.state || '-') + '</td>');
                    out.push('<td>' + codeBadge + '</td>');
                    out.push('<td>' + riskBadge + '</td>');
                    var ai = getAiRiskForTicket(it2.ticketId);
                    var aiHtml = '';
                    if (ai && ai.rationale) {
                      aiHtml = '<div class="ai-rationale"><span class="badge">AI ' + esc(ai.riskLevel || 'low') + '</span> ' + esc(ai.rationale) + '</div>';
                    }
                    out.push('<td>' + esc(it2.note || '') + aiHtml + '</td>');
                    out.push('</tr>');
                  }

                  out.push('</tbody></table>');
                }
              }

              out.push('</div>');
            }

            out.push('</div>');
            box.innerHTML = '<p><span class="badge">' + esc(js.date || "") + '</span></p>' + out.join('');
          });
      }

      function ymd(d) { return d.toISOString().slice(0, 10); }
      function addDays(iso, delta) {
        var d = new Date(String(iso || '') + 'T00:00:00');
        if (isNaN(d.getTime())) d = new Date();
        d.setDate(d.getDate() + delta);
        return ymd(d);
      }

      function loadReportRange() {
        var fromEl = document.getElementById('repFrom');
        var toEl = document.getElementById('repTo');
        var from = (fromEl && fromEl.value) ? fromEl.value : ymd(new Date());
        var to = (toEl && toEl.value) ? toEl.value : from;

        var devSel = document.getElementById('snapDev');
        var dev = (devSel && devSel.value) ? devSel.value : 'all';
        var devQ = (dev && dev !== 'all') ? ('&developer=' + encodeURIComponent(dev)) : '';

        var dl = document.getElementById('dlRange');
        if (dl) dl.href = '/api/updates/range.tsv?from=' + encodeURIComponent(from) + '&to=' + encodeURIComponent(to) + devQ;

        var hdrs = {};
        var tkn = localStorage.getItem('pocToken');
        if (tkn) hdrs['Authorization'] = 'Bearer ' + tkn;

        fetch('/api/updates/range?from=' + encodeURIComponent(from) + '&to=' + encodeURIComponent(to) + devQ, { headers: hdrs })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var tb = document.querySelector('#reportTbl tbody');
            if (!tb) return;
            var items = js.items || [];
            var html = '';
            for (var i = 0; i < items.length; i++) {
              var it = items[i];
              var d = (it.date || '').slice(0, 10);
              var who = it.assignedTo || '';
              var lt = who.indexOf('<');
              if (lt > -1) { who = who.slice(0, lt).trim(); }
              var bs = who.indexOf('\\');
              if (bs > -1 && lt === -1) { who = who.slice(bs + 1).trim(); }
              var typ3 = it.type || it.workItemType || it.itemType || it.kind || '';
              html += '<tr>' +
                '<td>' + esc(d) + '</td>' +
                '<td>' + esc(who) + '</td>' +
                '<td>' + esc(it.ticketId) + '</td>' +
                '<td>' + esc(typ3 || '') + '</td>' +
                '<td><i>' + esc(it.title || '') + '</i></td>' +
                '<td>' + esc(it.state || '') + '</td>' +
                '<td>' + esc(it.code || '') + '</td>' +
                '<td>' + esc(it.note || '') + '</td>' +
                '</tr>';
            }
            tb.innerHTML = html || '<tr><td colspan="8"><em>No rows for the selected range.</em></td></tr>';
          })
          .catch(function () {
            var tb = document.querySelector('#reportTbl tbody');
            if (tb) tb.innerHTML = '<tr><td colspan="8">Failed to load range.</td></tr>';
          });
      }


      function presetReportThisWeek(autoLoad) {
        var now = new Date();
        var day = now.getDay();
        var diffToMon = (day + 6) % 7;
        var monday = new Date(now); monday.setDate(now.getDate() - diffToMon);
        monday.setHours(0, 0, 0, 0);
        var sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23, 59, 59, 999);
        setReportRange(monday, sunday, !!autoLoad);
      }

      function setReportRange(fromDate, toDate, autoLoad) {
        var f = document.getElementById('repFrom');
        var t = document.getElementById('repTo');
        if (f) f.value = ymd(fromDate);
        if (t) t.value = ymd(toDate);
        saveReportInputs();

        if (autoLoad) loadReportRange();
      }

      function presetReportThisMonth(autoLoad) {
        var now = new Date();
        var first = new Date(now.getFullYear(), now.getMonth(), 1);
        var last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        setReportRange(first, last, !!autoLoad);
      }

      function renderCodeBadge(cell, code) {
        if (!cell) return;
        if (!code) { cell.textContent = '—'; return; }
        var fam = String(code).slice(0, 3);
        cell.innerHTML = '<span class="badge code-' + fam + '">' + esc(code) + '</span>';
      }

      function initShortcuts() {
        document.addEventListener('keydown', function (e) {
          var tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
          if (tag === 'input' || tag === 'textarea') return;
          var k = e.key || '';
          if (k === '/') { var q = byId('q'); if (q) { e.preventDefault(); q.focus(); } }
          else if (k.toLowerCase() === 'l') { var lb = byId('loadBtn'); if (lb) { e.preventDefault(); lb.click(); } }
          else if (k.toLowerCase() === 'n') { e.preventDefault(); openSPModal(); }
          else if ((e.ctrlKey || e.metaKey) && k === 'Enter') {
            var m = byId('spModal'); if (m && m.classList.contains('open')) {
              var sb = byId('submitBtn'); if (sb) sb.click();
            }
          }
        });
      }

      function setIterationLabel(name) {
        var el = byId('iterLabel');
        if (!el) return;
        name = (name || '').trim();
        if (name) { el.textContent = name; el.classList.remove('muted'); }
        else { el.textContent = '—'; el.classList.add('muted'); }
      }

      function refreshIterationBadge() {
        fetch((API || location.origin) + "/api/iteration/current")
          .then(function (r) { return r.json(); })
          .then(function (js) {
            var name = (js && js.name) ? String(js.name) : '';
            if (name.indexOf('\\') > -1) {
              var parts = name.split('\\');
              name = (parts[parts.length - 1] || '').trim();
            }
            setIterationLabel(name);
          })
          .catch(function () { });
      }

      function loadBlockers() {
        var tbody = document.querySelector('#blockersTbl tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        for (var i = 0; i < 4; i++) {
          var tr = document.createElement('tr');
          tr.className = 'skeleton';
          tr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
          tbody.appendChild(tr);
        }

        fetch((API || location.origin) + "/api/updates/blockers")
          .then(function (res) { return res.json(); })
          .then(function (js) {
            var items = js.items || [];
            window.__blockersMap = {};
            for (var i = 0; i < items.length; i++) {
              var it = items[i];
              window.__blockersMap[String(it.ticketId)] = it;
            }

            function sev(c) {
              if (!c) return 9;
              if (String(c).indexOf('600_') === 0) return 0;
              if (String(c).indexOf('700_') === 0) return 1;
              if (String(c).indexOf('800_') === 0) return 2;
              return 3;
            }
            function riskRank(level) {
              var l = String(level || '').toLowerCase();
              return l === 'high' ? 3 : l === 'medium' ? 2 : l === 'low' ? 1 : 0;
            }
            items.sort(function (a, b) {
              return riskRank(b.riskLevel) - riskRank(a.riskLevel)
                || sev(a.code) - sev(b.code)
                || String(a.assignedTo || '').localeCompare(String(b.assignedTo || ''))
                || String(b.at || '').localeCompare(String(a.at || ''));
            });

            if (!items.length) {
              tbody.innerHTML = '<tr><td colspan="9"><em>No blockers detected today.</em></td></tr>';
              return;
            }

            var html = '';
            for (var j = 0; j < items.length; j++) {
              var h = items[j];
              var typ = h.type || h.workItemType || h.itemType || h.kind || '';
              var riskBadge = riskBadgeHtml(h.riskLevel, h.riskReasons);
              // inside the loop that builds each row (loadBlockers)
              html += ''
                + '<tr data-id="' + esc(h.ticketId) + '">'
                + '<td>' + esc(h.ticketId) + '</td>'
                + '<td>' + esc(typ || '-') + '</td>'
                + '<td><i>' + esc(h.title || '') + '</i></td>'
                + '<td>' + esc(h.state || '') + '</td>'
                + '<td>' + esc(h.code || '-') + '</td>'
                + '<td>' + riskBadge + '</td>'
                + '<td>' + esc(h.note || '') + '</td>'
                + '<td>' + esc(h.iterationPath || '') + '</td>'
                + '<td><button class="secondary assist-btn" onclick="aiAssistRow(this)">Assist</button></td>'
                + '</tr>';

            }
            tbody.innerHTML = html;

            var rows = tbody.querySelectorAll('tr');
            for (var r = 0; r < rows.length; r++) {
              var cells = rows[r].getElementsByTagName('td');
              if (cells[4]) {
                var raw = cells[4].textContent;
                renderCodeBadge(cells[4], raw);
              }
            }
          })
          .catch(function () {
            tbody.innerHTML = '<tr><td colspan="9">Failed to load blockers.</td></tr>';
          });
      }

      function runTriage() {
        var st = document.getElementById('triageStatus');
        if (st) { st.textContent = 'Thinking...'; st.classList.remove('ok', 'err'); }
        fetch((window.API || location.origin) + '/api/ai/triage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('pocToken') || '')
          },
          body: JSON.stringify({})
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (js && js.error) { if (st) { st.textContent = js.error; st.classList.add('err'); } return; }
            var suggestions = js && js.suggestions ? js.suggestions : [];
            if (st) { st.textContent = 'Ready'; st.classList.add('ok'); }
            renderTriage(suggestions);
          })
          .catch(function () {
            if (st) { st.textContent = 'Network error'; st.classList.add('err'); }
          });
      }

      function renderTriage(suggestions) {
        var panel = document.getElementById('triagePanel');
        var list = document.getElementById('triage-list');
        if (!list) return;

        if (!suggestions || !suggestions.length) {
          if (panel) panel.classList.add('hidden');
          list.innerHTML = '';
          return;
        }

        // keep a simple priority list (highest risk first for ordering only)
        suggestions = suggestions.slice().sort(function (a, b) { return (b.risk || 0) - (a.risk || 0); });

        var isPM = (window.__role === 'pm');
        var html = '';
        for (var i = 0; i < suggestions.length; i++) {
          var s = suggestions[i];

          // optional quick-apply for devs if model suggests a progress code
          var applyBtn = (!isPM && s.suggest_code)
            ? (' <button class="secondary" onclick="applySuggestedCode(\'' +
              String(s.id).replace(/"/g, '&quot;') + '\', \'' +
              String(s.suggest_code).replace(/"/g, '&quot;') + '\')">Apply ' +
              esc(s.suggest_code) + '</button>')
            : '';

          html += ''
            + '<li style="margin-bottom:12px;">'
            + '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">'
            + '<strong>#' + esc(s.id) + '</strong>' + applyBtn +
            '</div>'
            + (s.reason ? ('<div style="margin-top:6px;"><b>Why:</b> ' + esc(s.reason) + '</div>') : '')
            + (Array.isArray(s.next_steps) && s.next_steps.length
              ? ('<ol style="margin:6px 0 0 18px;">' + s.next_steps.map(function (x) { return '<li>' + esc(x) + '</li>'; }).join('') + '</ol>')
              : '<div style="margin-top:6px;"><em>No steps suggested.</em></div>')
            + (s.owner_hint ? ('<div style="margin-top:6px;"><b>Owner hint:</b> ' + esc(s.owner_hint) + '</div>') : '')
            + '</li>';
        }
        list.innerHTML = html;
        if (panel) panel.classList.remove('hidden');
      }


      function applySuggestedCode(id, code) {
        if (window.__role === 'pm') return;
        if (window.__lockedToday) {
          var st = document.getElementById('submitStatus');
          if (st) { st.textContent = 'Day is locked. Ask a PM to unlock to change updates.'; st.classList.add('err'); }
          return;
        }
        openSPModal(id);
        var codeSel = document.getElementById('code');
        if (codeSel) {
          codeSel.value = code;
          if (typeof syncNoteRequirement === 'function') syncNoteRequirement();
        }
        var t = document.getElementById('tId'); if (t) t.value = String(id || '');
        var note = document.getElementById('note'); if (note) note.focus();
      }

      function loadMissing() {
        var box = byId("missing");
        fetch((API || location.origin) + "/api/updates/missing", { headers: { "Authorization": "Bearer " + (localStorage.getItem("pocToken") || "") } })
          .then(function (res) { return res.json(); })
          .then(function (js) {
            if (js.error) { box.innerHTML = '<p class="status err">' + esc(js.error) + '</p>'; return; }
            if (!js.missing || js.missing.length === 0) { box.innerHTML = '<p><span class="badge">' + esc(js.date || "") + '</span> — everyone has updated 🎉</p>'; return; }
            var html = '<p><span class="badge">' + esc(js.date || "") + '</span> — ' + js.count + ' dev(s) with no update</p><ul>';
            for (var i = 0; i < js.missing.length; i++) { var m = js.missing[i]; html += '<li>' + esc(m.label) + ' <small>(' + esc(m.email) + ')</small></li>'; }
            html += '</ul>';
            box.innerHTML = html;
          });
      }


      function pmUnlockUser(btn) {
        try {
          var email = (btn && btn.getAttribute('data-email')) || '';
          var tkn = localStorage.getItem('pocToken') || '';

          if (!tkn) { alert('Please login first.'); return; }
          if (!email) { alert('Missing user email.'); return; }

          var old = btn.textContent;
          btn.disabled = true;
          btn.textContent = 'Unlocking…';

          fetch((window.API || location.origin) + '/api/updates/unlock', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + tkn
            },
            body: JSON.stringify({ email: email })
          })
            .then(function (r) { return r.json(); })
            .then(function (js) {
              if (js && js.error) throw new Error(js.error);

              // Refresh the Pre-Meeting list so the badge flips to "Open"
              if (typeof loadToday === 'function') loadToday();
              // Also refresh "Who hasn't updated yet" (useful if you show lock status there later)
              if (typeof loadMissing === 'function') loadMissing();
            })
            .catch(function (e) {
              alert('Unlock failed: ' + (e && e.message ? e.message : e));
            })
            .finally(function () {
              // slight delay so refresh doesn’t fight the immediate re-enable
              setTimeout(function () {
                try { btn.disabled = false; btn.textContent = old; } catch (_) { }
              }, 250);
            });
        } catch (e) {
          try { console.error(e); } catch (_) { }
        }
      }



      document.addEventListener('DOMContentLoaded', function () {
        restoreReportInputs();
        updateEmailBtnDisabled();

        // if snapDev exists already, persist on change (covers devs who become PMs mid-session)
        var sd = byId('snapDev'); if (sd) sd.addEventListener('change', saveReportInputs);


        var codeSel = byId('code');
        ['repFrom', 'repTo', 'snapDev'].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener('change', saveReportInputs);
        });


        if (codeSel) codeSel.addEventListener('change', syncNoteRequirement);
        syncNoteRequirement();

        var tkn = token();
        if (tkn) {
          fetch((API || location.origin) + "/api/me", { headers: { "Authorization": "Bearer " + tkn } })
            .then(function (res) { if (!res.ok) throw new Error('auth'); return res.json(); })
            .then(function (js) {
              setMe(js.email, js.name);
              var asn = byId("assigned"); if (asn && !asn.value && js.email) asn.value = js.email.split('@')[0];
              setRoleUI(js.role || 'dev');
              refreshIterationBadge();
              setStatus("loginStatus", "Logged in.");
              checkLockStatus();
            })
            .catch(function () { localStorage.removeItem(tokenKey); });
        }
      });

      initShortcuts();

      var tryLogin = function (e) { if (e.key === 'Enter') login(); };
      var lem = byId('loginEmail'); if (lem) lem.addEventListener('keydown', tryLogin);
      var lpw = byId('loginPw'); if (lpw) lpw.addEventListener('keydown', tryLogin);

      document.body.addEventListener('htmx:afterSwap', function (ev) {
        var tgt = ev.target || (ev.detail && ev.detail.target);
        if (tgt && tgt.id === 'code' && typeof syncNoteRequirement === 'function') {
          syncNoteRequirement();
        }
      });

      function aiAssistRow(btn) {
        var tr = btn && btn.closest ? btn.closest('tr') : null;
        if (!tr) return;

        // If an AI row already exists under this ticket, just disable the button and bail
        var next = tr.nextElementSibling;
        if (next && next.classList && next.classList.contains('ai-row')) {
          btn.disabled = true;
          btn.textContent = 'Assisted';
          return;
        }

        var id = tr.getAttribute('data-id');
        var item = (window.__blockersMap || {})[String(id)];
        if (!item) return;

        var st = document.getElementById('aiStatus');
        if (st) { st.textContent = 'Thinking...'; st.classList.remove('err', 'ok'); }

        fetch((window.API || location.origin) + '/api/ai/triage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('pocToken') || '') },
          body: JSON.stringify({ items: [item] })
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (js && js.error) { if (st) { st.textContent = js.error; st.classList.add('err'); } return; }
            var s = (js && js.suggestions && js.suggestions[0]) ? js.suggestions[0] : null;
            if (!s) { if (st) { st.textContent = 'No suggestion'; st.classList.add('err'); } return; }
            if (st) { st.textContent = 'Ready'; st.classList.add('ok'); }

            renderAiSuggestionRow(tr, s);

            // Disable the Assist button for this row
            btn.disabled = true;
            btn.textContent = 'Assisted';
          })
          .catch(function () {
            if (st) { st.textContent = 'Network error'; st.classList.add('err'); }
          });
      }

      function renderAiSuggestionRow(tr, s) {
        // If AI row already exists, do nothing (no toggle)
        var next = tr.nextElementSibling;
        if (next && next.classList && next.classList.contains('ai-row')) return;

        var tdCount = tr.children.length;
        var row = document.createElement('tr');
        row.className = 'ai-row';
        var td = document.createElement('td');
        td.colSpan = tdCount;
        td.style.background = 'var(--table-head)';
        td.innerHTML =
          '<div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">' +
          (s.risk ? ('<div class="badge">Risk: ' + esc(String(s.risk)) + '</div>') : '') +
          (s.slipRisk ? ('<div class="badge">' + esc(s.slipRisk) + ' slip risk</div>') : '') +
          (s.suggest_code ? ('<div class="badge">Suggest code: ' + esc(s.suggest_code) + '</div>') : '') +
          '</div>' +
          (s.reason ? ('<p style="margin:8px 0;"><b>Why:</b> ' + esc(s.reason) + '</p>') : '') +
          (Array.isArray(s.next_steps) && s.next_steps.length
            ? ('<ol style="margin:8px 0 0 20px;">' + s.next_steps.map(function (x) { return '<li>' + esc(x) + '</li>'; }).join('') + '</ol>')
            : '<p><em>No steps suggested.</em></p>') +
          (s.chase_message
            ? ('<div class="copy-chase-wrap" style="margin-top:8px;"><b>Chase:</b> '
              + '<code style="white-space:pre-wrap;">' + esc(s.chase_message) + '</code> '
              + '<button class="secondary" onclick="copyChaseFromButton(this)">Copy</button>'
              + '</div>')
            : '') +
          (s.owner_hint ? ('<p style="margin-top:8px;"><b>Owner hint:</b> ' + esc(s.owner_hint) + '</p>') : '');
        row.appendChild(td);
        tr.parentNode.insertBefore(row, tr.nextSibling);
      }

      // --- Dev Assist: "Draft Chase" / "What's Next?" -----------------------------

      function devAssistFromRow(btn, mode) {
        var tr = btn && btn.closest ? btn.closest('tr') : null;
        if (!tr) return;
        var id = tr.getAttribute('data-id');
        if (!id) return;

        // prevent duplicates: if an AI row already exists, just disable the clicked button
        var next = tr.nextElementSibling;
        if (next && next.classList && next.classList.contains('ai-row')) {
          btn.disabled = true; btn.textContent = 'Assisted'; return;
        }

        var tkn = token();
        if (!tkn) { alert('Please login first.'); return; }

        // Pull light context from the row (and from server-provided fields in the table JSON)
        var cells = tr.getElementsByTagName('td');
        var type = cells[1] ? cells[1].textContent.trim() : '';
        var title = cells[2] ? cells[2].textContent.trim() : '';
        var state = cells[3] ? cells[3].textContent.trim() : '';
        var lastCode = cells[5] ? cells[5].textContent.trim() : '';
        var lastNote = cells[6] ? cells[6].textContent.trim() : '';

        // Optional: try to attach tags if present (your /api/tickets already returns t.tags)
        // We stashed the last loaded items in a weak map for convenience (fallback safe)
        var tags = '';
        try {
          if (window.__lastTickets && window.__lastTickets[String(id)]) {
            tags = String(window.__lastTickets[String(id)].tags || '');
          }
        } catch (_) { }

        // Insert an AI "thinking…" skeleton row
        var tdCount = tr.children.length;
        var row = document.createElement('tr');
        row.className = 'ai-row';
        var td = document.createElement('td');
        td.colSpan = tdCount;
        td.style.background = 'var(--table-head)';
        td.innerHTML = '<div class="muted">🤖 Thinking…</div>';
        row.appendChild(td);
        tr.parentNode.insertBefore(row, tr.nextSibling);

        // Disable clicked button while we wait
        var old = btn.textContent; btn.disabled = true; btn.textContent = 'Thinking…';

        fetch((window.API || location.origin) + '/api/ai/dev-assist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + tkn
          },
          body: JSON.stringify({
            mode: mode,
            ticket: { id: id, title: title, state: state },
            context: { lastNote: lastNote, currentNote: lastNote, tags: tags }
          })
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (!js || js.status !== 'ok') throw new Error(js && js.error || 'AI error');
            renderDevAssistRow(tr, mode, js.result);
            btn.textContent = 'Assisted'; // keep disabled to prevent spamming
          })
          .catch(function (e) {
            // show error inside the AI row
            try { td.innerHTML = '<div class="muted err">AI failed: ' + esc(String(e.message || e)) + '</div>'; } catch (_) { }
            btn.textContent = old; btn.disabled = false;
          });
      }

      function renderDevAssistRow(tr, mode, result) {
        // If the placeholder row exists (inserted in devAssistFromRow), reuse it; else create one
        var next = tr.nextElementSibling, row, td;
        if (next && next.classList && next.classList.contains('ai-row')) {
          row = next; td = row.firstElementChild;
          td.innerHTML = ''; // clear the "thinking" content
        } else {
          var tdCount = tr.children.length;
          row = document.createElement('tr'); row.className = 'ai-row';
          td = document.createElement('td'); td.colSpan = tdCount; td.style.background = 'var(--table-head)';
          row.appendChild(td); tr.parentNode.insertBefore(row, tr.nextSibling);
        }

        if (mode === 'chase') {
          var who = result.who ? '<p>👥 Suggested ping: <b>' + esc(result.who) + '</b></p>' : '';
          var text = String(result.chase_text || '').trim();

          td.innerHTML =
            '<div class="badge danger">Blocker Assist</div>' +
            who +
            (text
              ? '<div class="copy-chase-wrap" style="margin-top:8px;">'
              + '<b>Chase:</b> <code style="white-space:pre-wrap;">' + esc(text) + '</code> '
              + '<button class="secondary" onclick="copyChaseFromButton(this)">Copy</button>'
              + '</div>'
              : '<p><em>No chase text returned.</em></p>');
        } else {
          // mode === 'next'
          var steps = Array.isArray(result.next_steps) ? result.next_steps : [];
          var list = steps.length
            ? ('<ol style="margin:8px 0 0 20px;">'
              + steps.map(function (x) { return '<li>' + esc(String(x)) + '</li>'; }).join('')
              + '</ol>')
            : '<p><em>No steps suggested.</em></p>';

          var flat = steps.join('; ');
          td.innerHTML =
            '<div class="badge accent">Next Steps</div>' +
            list +
            '<div class="row" style="margin-top:8px;">'
            + '<button class="primary" onclick="insertIntoNote(\'' + esc(flat).replace(/'/g, "\'") + '\')">Insert to Note</button>'
            + '</div>';
        }
      }

      // --- Dev Assist: modal actions (Draft Chase / What's Next) ------------------
      function devAssistFromModal(mode) {
        var tkn = token();
        if (!tkn) { alert('Please login first.'); return; }

        var id = byId('tId') ? byId('tId').value.trim() : '';
        var code = byId('code') ? byId('code').value.trim() : '';
        var note = byId('note') ? byId('note').value.trim() : '';
        var t = (window.__lastTickets || {})[String(id)] || {};
        var title = t && t.title ? t.title : '';
        var state = t && t.state ? t.state : '';
        var tags = t && t.tags ? t.tags : '';

        var panel = byId('assistResult');
        if (panel) panel.innerHTML = '<div class="muted">🤖 Thinking…</div>';

        fetch((window.API || location.origin) + '/api/ai/dev-assist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tkn },
          body: JSON.stringify({
            mode: mode,
            ticket: { id: id, title: title, state: state },
            context: { currentNote: note, lastNote: note, tags: tags, selectedCode: code }
          })
        })
          .then(function (r) { return r.json(); })
          .then(function (js) {
            if (!js || js.status !== 'ok') throw new Error(js && js.error || 'AI error');
            renderDevAssistInModal(mode, js.result);
          })
          .catch(function (e) {
            if (panel) panel.innerHTML = '<div class="muted err">AI failed: ' + esc(String(e.message || e)) + '</div>';
          });
      }

      function renderDevAssistInModal(mode, result) {
        var panel = byId('assistResult');
        if (!panel) return;

        if (mode === 'chase') {
          var who = result.who ? '<p>👥 Suggested ping: <b>' + esc(result.who) + '</b></p>' : '';
          var text = String(result.chase_text || '').trim();
          panel.innerHTML =
            '<div class="badge danger">Blocker Assist</div>' +
            who +
            (text
              ? '<div class="copy-chase-wrap" style="margin-top:8px;">'
              + '<b>Chase:</b> <code style="white-space:pre-wrap;">' + esc(text) + '</code> '
              + '<button class="secondary" onclick="copyChaseFromButton(this)">Copy</button>'
              + '</div>'
              : '<p><em>No chase text returned.</em></p>');
        } else {
          // mode === 'next'
          var steps = Array.isArray(result.next_steps) ? result.next_steps : [];
          var list = steps.length
            ? ('<ol style="margin:8px 0 0 20px;">' + steps.map(function (x) { return '<li>' + esc(String(x)) + '</li>'; }).join('') + '</ol>')
            : '<p><em>No steps suggested.</em></p>';

          var flat = steps.join('; ');

          // render button with an id, then bind click in JS (avoids escaping headaches)
          panel.innerHTML =
            '<div class="badge accent">Next Steps</div>' +
            list +
            '<div class="row" style="margin-top:8px;">' +
            '<button id="insertNextBtn" class="primary">Insert to Note</button>' +
            '</div>';

          var btn = document.getElementById('insertNextBtn');
          if (btn) btn.onclick = function () { insertIntoNote(flat); };
        }

      }


      // Helper: append AI text into the Submit form's Note (keeps existing content)
      function insertIntoNote(text) {
        try {
          var note = document.getElementById('note');
          if (!note) { openSPModal(document.getElementById('tId').value || ''); note = document.getElementById('note'); }
          if (!note) return;
          var cur = String(note.value || '').trim();
          note.value = (cur ? cur + '\\n' : '') + String(text || '');
          note.focus();
        } catch (_) { }
      }
      function updateAssistAvailability() {
        var codeSel = byId('code');
        var hasCode = !!(codeSel && codeSel.value && codeSel.value.trim());
        var fam = hasCode ? String(codeSel.value).slice(0, 3) : '';

        var chaseBtn = byId('draftChaseBtn');
        var nextBtn = byId('whatsNextBtn');

        if (nextBtn) nextBtn.disabled = !hasCode;
        // “Chase” is most useful for 600/700/800 families; keep it disabled otherwise
        if (chaseBtn) chaseBtn.disabled = !(hasCode && /^(600|700|800)$/.test(fam));
      }



      function copyText(txt) {
        try { navigator.clipboard.writeText(String(txt || '')); } catch (_) { }
      }
      function copyChaseFromButton(btn) {
        try {
          // Find the wrapper (span.copy-chase-wrap OR any ancestor that has one)
          var wrap = null;

          if (btn && btn.closest) {
            wrap = btn.closest('.copy-chase-wrap') || btn.closest('div');
          }

          // Fallback: walk up until we hit .copy-chase-wrap or the body
          if (!wrap) {
            var p = btn && btn.parentNode;
            while (p && p !== document.body && !wrap) {
              if (p.classList && p.classList.contains('copy-chase-wrap')) wrap = p;
              else p = p.parentNode;
            }
          }

          // Locate the <code> with the raw chase text
          var codeEl = (wrap && wrap.querySelector && wrap.querySelector('code')) || btn.previousElementSibling;
          var raw = codeEl ? codeEl.textContent : '';

          if (!raw) {
            // Nothing to copy
            var old0 = btn.textContent;
            btn.textContent = 'No text';
            btn.disabled = true;
            setTimeout(function () { btn.textContent = old0; btn.disabled = false; }, 900);
            return;
          }

          // Try modern clipboard, fallback to legacy
          var notify = function (ok) {
            var old = btn.textContent;
            btn.textContent = ok ? 'Copied!' : 'Copy failed';
            btn.disabled = true;
            setTimeout(function () { btn.textContent = old; btn.disabled = false; }, 900);
          };

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(raw).then(function () { notify(true); }).catch(function () {
              legacyCopy(raw) ? notify(true) : notify(false);
            });
          } else {
            legacyCopy(raw) ? notify(true) : notify(false);
          }
        } catch (e) {
          try { console.error(e); } catch (_) { }
        }
      }

      function legacyCopy(text) {
        try {
          var ta = document.createElement('textarea');
          ta.value = String(text || '');
          ta.style.position = 'fixed';
          ta.style.top = '-1000px';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          var ok = false;
          try { ok = document.execCommand('copy'); } catch (_) { ok = false; }
          document.body.removeChild(ta);
          return ok;
        } catch (_) { return false; }
      }

      // --- NEW: AI triage cache + annotation + sorting ---

      var __triageCache = { ts: 0, map: {} };

      function cacheTriage(suggestions) {
        var m = {};
        for (var i = 0; i < suggestions.length; i++) {
          var s = suggestions[i];
          m[String(s.id)] = s;
        }
        __triageCache = { ts: Date.now(), map: m };
      }

      function getCachedTriage() {
        if (!__triageCache.ts) return null;
        if (Date.now() - __triageCache.ts > 5 * 60 * 1000) return null;
        return __triageCache.map;
      }

      function annotateBlockersWithAI(suggestions) {
        if (!suggestions || !suggestions.length) return;

        // cache for 5 minutes
        cacheTriage(suggestions);

        var byId = {};
        for (var i = 0; i < suggestions.length; i++) {
          var s = suggestions[i];
          byId[String(s.id)] = s;
        }

        var tbody = document.querySelector('#blockersTbl tbody');
        if (!tbody) return;
        var rows = tbody.querySelectorAll('tr');

        for (var r = 0; r < rows.length; r++) {
          var tr = rows[r];
          var id = tr.getAttribute('data-id');
          var s2 = byId[String(id)];
          if (!s2) { tr.removeAttribute('data-risk'); continue; }

          tr.setAttribute('data-risk', String(s2.risk || 0));
          tr.setAttribute('data-slips', (s2.slipRisk || '').toLowerCase());

          var tds = tr.getElementsByTagName('td');
          var cell = tds[tds.length - 1];

          var slip = (s2.slipRisk || '').toLowerCase();
          var slipClass = slip ? (' slip-' + slip) : '';

          var applyBtn = (window.__role !== 'pm' && s2.suggest_code)
            ? (' <button class="secondary" onclick="applySuggestedCode(\'' + String(id).replace(/"/g, '&quot;') + '\', \'' + String(s2.suggest_code).replace(/"/g, '&quot;') + '\')">Apply ' + esc(s2.suggest_code) + '</button>')
            : '';

          var chaseBtn = s2.chase_message
            ? (' <span class="copy-chase-wrap" style="display:inline-flex;gap:6px;align-items:center;">'
              + '<code style="display:none;">' + esc(s2.chase_message) + '</code>'
              + '<button class="secondary" onclick="copyChaseFromButton(this)">Copy chase</button>'
              + '</span>')
            : '';


          cell.innerHTML =
            '<span class="badge risk-' + String(s2.risk || 0) + '">Risk ' + esc(String(s2.risk || '')) + '</span> ' +
            (slip ? '<span class="badge' + slipClass + '">' + esc(s2.slipRisk) + ' slip</span> ' : '') +
            (s2.suggest_code ? '<span class="badge">' + esc(s2.suggest_code) + '</span> ' : '') +
            applyBtn + chaseBtn;
        }

        // enable the "Order by risk" button once we have some annotation
        var ob = document.getElementById('orderByRiskBtn');
        if (ob) ob.disabled = false;
      }

      function orderBlockersByAIRisk() {
        var tbody = document.querySelector('#blockersTbl tbody');
        if (!tbody) return;

        var tri = getCachedTriage();
        if (!tri) {
          var btn = document.getElementById('triageAllBtn');
          if (btn) btn.click();
        }

        var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
        if (!rows.length) return;

        function slipRank(slip) {
          var s = (slip || '').toLowerCase();
          return s === 'high' ? 3 : s === 'medium' ? 2 : s === 'low' ? 1 : 0;
        }

        rows.sort(function (a, b) {
          var ra = +(a.getAttribute('data-risk') || 0);
          var rb = +(b.getAttribute('data-risk') || 0);
          if (rb !== ra) return rb - ra;
          var sa = slipRank(a.getAttribute('data-slips'));
          var sb = slipRank(b.getAttribute('data-slips'));
          if (sb !== sa) return sb - sa;
          return 0;
        });

        for (var i = 0; i < rows.length; i++) tbody.appendChild(rows[i]);
      }

      // Override "Triage all" to also annotate table + enable sorting
      (function wrapRunTriage() {
        var orig = runTriage;
        window.runTriage = function () {
          var st = document.getElementById('triageStatus');
          if (st) { st.textContent = 'Thinking...'; st.classList.remove('ok', 'err'); }

          fetch((window.API || location.origin) + '/api/ai/triage', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('pocToken') || '')
            },
            body: JSON.stringify({})
          })
            .then(function (r) { return r.json(); })
            .then(function (js) {
              if (js && js.error) { if (st) { st.textContent = js.error; st.classList.add('err'); } return; }
              var suggestions = (js && js.suggestions) ? js.suggestions : [];
              if (st) { st.textContent = 'Ready'; st.classList.add('ok'); }
              annotateBlockersWithAI(suggestions);
              renderTriage(suggestions);
            })
            .catch(function () {
              if (st) { st.textContent = 'Network error'; st.classList.add('err'); }
            });
        };
      })();

      // expose
      window.aiAssistRow = aiAssistRow;
      window.signup = signup;
      window.login = login;
      window.logout = logout;
      window.loadTickets = loadTickets;
      window.loadWeeklySummary = loadWeeklySummary;
      window.prefill = prefill;
      window.submitProgress = submitProgress;
      window.lockDay = lockDay;
      window.loadMissing = loadMissing;

      window.pmUnlockUser = pmUnlockUser;
      window.loadBlockers = loadBlockers;
      window.loadToday = loadToday;
      window.openSPModal = openSPModal;
      window.closeSPModal = closeSPModal;
      window.loadReportRange = loadReportRange;
      window.presetReportThisWeek = presetReportThisWeek;
      window.presetReportThisMonth = presetReportThisMonth;
      window.runTriage = runTriage;
      window.applySuggestedCode = applySuggestedCode;
      window.copyChaseFromButton = copyChaseFromButton;
      window.orderBlockersByAIRisk = orderBlockersByAIRisk;
      window.annotateBlockersWithAI = annotateBlockersWithAI;
      window.prepareDevAssistUI = prepareDevAssistUI;
      window.applySuggestedCodeToModal = applySuggestedCodeToModal;
      window.devAssistFromModal = devAssistFromModal;
      window.renderDevAssistInModal = renderDevAssistInModal;
      window.openSnapshots = openSnapshots;
      window.emailSnapshots = emailSnapshots;


    })();
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</body>

</html>
